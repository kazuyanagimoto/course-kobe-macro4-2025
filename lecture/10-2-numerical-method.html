<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="柳本和春">
<meta name="dcterms.date" content="2025-10-11">

<title>数値計算の補足 – Family Macroeconomics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../static/img/logo.drawio.svg" rel="icon" type="image/svg+xml">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-d1f10ae5b1bd2fcd88626ad4c33800b6.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-a5387b16c79744f55f942101f6586ee8.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-d1f10ae5b1bd2fcd88626ad4c33800b6.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-29a9cb4b6e38590d1988549b314d426b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-2481093b93c3456eab0eea680925ecdf.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-29a9cb4b6e38590d1988549b314d426b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="数値計算の補足 – Family Macroeconomics">
<meta property="og:description" content="">
<meta property="og:image" content="https://kazuyanagimoto.github.io/course-kobe-macro4-2025/lecture/static/img/sns-card.drawio.png">
<meta property="og:site_name" content="Family Macroeconomics">
<meta property="og:locale" content="ja_JP">
<meta name="twitter:title" content="数値計算の補足 – Family Macroeconomics">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://kazuyanagimoto.github.io/course-kobe-macro4-2025/lecture/static/img/sns-card.drawio.png">
<meta name="twitter:creator" content="@kazuyanagimoto">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Family Macroeconomics</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../lecture.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kazuyanagimoto/course-kobe-macro4-2025"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#計算量" id="toc-計算量" class="nav-link active" data-scroll-target="#計算量">計算量</a>
  <ul class="collapse">
  <li><a href="#時間計算量" id="toc-時間計算量" class="nav-link" data-scroll-target="#時間計算量">時間計算量</a></li>
  <li><a href="#領域計算量" id="toc-領域計算量" class="nav-link" data-scroll-target="#領域計算量">領域計算量</a></li>
  <li><a href="#計算量の実践" id="toc-計算量の実践" class="nav-link" data-scroll-target="#計算量の実践">計算量の実践</a></li>
  </ul></li>
  <li><a href="#微分" id="toc-微分" class="nav-link" data-scroll-target="#微分">微分</a>
  <ul class="collapse">
  <li><a href="#数式微分-symbolic-differentiation" id="toc-数式微分-symbolic-differentiation" class="nav-link" data-scroll-target="#数式微分-symbolic-differentiation">数式微分 (Symbolic Differentiation)</a></li>
  <li><a href="#数値微分-numerical-differentiation" id="toc-数値微分-numerical-differentiation" class="nav-link" data-scroll-target="#数値微分-numerical-differentiation">数値微分 (Numerical Differentiation)</a></li>
  <li><a href="#自動微分-automatic-differentiation" id="toc-自動微分-automatic-differentiation" class="nav-link" data-scroll-target="#自動微分-automatic-differentiation">自動微分 (Automatic Differentiation)</a></li>
  </ul></li>
  <li><a href="#並列計算" id="toc-並列計算" class="nav-link" data-scroll-target="#並列計算">並列計算</a></li>
  <li><a href="#monte-carlo-simulation-for-smm" id="toc-monte-carlo-simulation-for-smm" class="nav-link" data-scroll-target="#monte-carlo-simulation-for-smm">Monte Carlo Simulation for SMM</a>
  <ul class="collapse">
  <li><a href="#良い実装例" id="toc-良い実装例" class="nav-link" data-scroll-target="#良い実装例">良い実装例</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">数値計算の補足</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">柳本和春 <a href="mailto:yanagimoto@econ.kobe-u.ac.jp" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0009-0007-1967-8304" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            神戸大学
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 11, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">January 16, 2026</p>
    </div>
  </div>
    
  </div>
  


</header>


<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>このページは数値計算に関する補足を雑多にまとめたものです. 書きかけの内容を多く含みます.</p>
</div>
</div>
<div id="setup" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LaTeXStrings</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Roots</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Optimization</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">OptimizationNLopt</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Random</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(<span class="fl">1234</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">default</span>(size<span class="op">=</span>(<span class="fl">500</span>, <span class="fl">309</span>), titlefontsize<span class="op">=</span><span class="fl">10</span>, fmt<span class="op">=:</span>svg)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="計算量" class="level2">
<h2 class="anchored" data-anchor-id="計算量">計算量</h2>
<p>アルゴリズムの効率性を評価する尺度として、計算時間とメモリ使用量があります. ここでいう計算時間とは, アルゴリズムが終了するまでにかかるステップ数 (<strong>時間計算量</strong>, time complexity) のことをいい, 実際のPC上での実行時間とは異なります. より高いスペックのPCを使えば, 同じアルゴリズムでも実行時間は短くなる一方で, ステップ数の次元が異なるアルゴリズムはマシンの性能に関わらず効率的と言えます.また, メモリ使用量とはアルゴリズムが終了するまでに必要なメモリの量 (<strong>領域計算量</strong>, space complexity) のことをいいます.</p>
<section id="時間計算量" class="level3">
<h3 class="anchored" data-anchor-id="時間計算量">時間計算量</h3>
<p>時間計算量は, 入力の大きさ <span class="math inline">\(n\)</span> に対するステップ数 <span class="math inline">\(T(n)\)</span> の関数として表されます. 例えば, 配列の要素数が <span class="math inline">\(n\)</span> のときに, すべての要素を1回ずつ見るアルゴリズムは, <span class="math inline">\(T(n) = n\)</span> となります. また, 2重ループで配列のすべての組み合わせを調べるアルゴリズムは, <span class="math inline">\(T(n) = n^2\)</span> となります. このように, アルゴリズムの時間計算量は, 入力の大きさに対するステップ数の増加率によって特徴づけられます.</p>
<p>時間計算量を評価する際, 重要なのは支配的な項の次元数になります. 例えば, <span class="math inline">\(T(n) = 3n^2 + 2n + 1\)</span> の場合, <span class="math inline">\(n\)</span> が大きくなると <span class="math inline">\(3n^2\)</span> の項が支配的になるため, <span class="math inline">\(n^2\)</span> に着目すれば十分です. この考え方に従ったとき, 計算量を <span class="math inline">\(O(n^2)\)</span> と表記します. より厳密に表現すると以下のようになります.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span><span class="math inline">\(O\)</span>-記法
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math inline">\(f(n)\)</span> が <span class="math inline">\(O(g(n))\)</span> とは, 任意の <span class="math inline">\(n \ge 0\)</span> に対して, ある定数 <span class="math inline">\(C &gt; 0\)</span> が存在して, 以下の不等式が成り立つことをいう.</p>
<p><span class="math display">\[
|f(n)| \le C |g(n)|.
\]</span></p>
</div>
</div>
<p>定量モデルで気にする必要があるのは, ほとんどの場合, グリッド数によるオーダーです. 例えば, <span class="math inline">\(V(k, z)\)</span> のような2次元の価値関数をグリッド上で計算する場合, <span class="math inline">\(k\)</span> のグリッド数 <span class="math inline">\(n_k\)</span> と <span class="math inline">\(z\)</span> のグリッド数 <span class="math inline">\(n_z\)</span> に対して, 計算量は <span class="math inline">\(n_k n_z\)</span> の関数となります.</p>
</section>
<section id="領域計算量" class="level3">
<h3 class="anchored" data-anchor-id="領域計算量">領域計算量</h3>
<p>領域計算量は, アルゴリズムが終了するまでに必要なメモリの量を, 入力の大きさ <span class="math inline">\(n\)</span> に対する関数として表します. 例えば, 配列の要素数が <span class="math inline">\(n\)</span> のときに, すべての要素を保存するアルゴリズムは, 領域計算量が <span class="math inline">\(O(n)\)</span> となります. また, 2次元配列を保存するアルゴリズムは, 領域計算量が <span class="math inline">\(O(n^2)\)</span> となります.</p>
<p><strong>メモリのヒエラルキー</strong></p>
<p>なぜメモリの使用量が重要なのでしょうか. 近年のPCは何百GBもの容量があるし, いくら使おうと問題ではないのではないか, と思うかもしれません. しかし, 実際には, メモリのヒエラルキー (memory hierarchy) によって, メモリの速度と容量が大きく異なります.</p>
<p>一般に, 高速なメモリは高価であるため搭載量が少なく, 低速なメモリは安価であるため搭載量が多いです. それらを合わせると <a href="#fig-memory-hierarchy" class="quarto-xref">図&nbsp;1</a> ようなピラミッド型のヒエラルキーが形成されます.</p>
<div id="fig-memory-hierarchy" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-memory-hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../static/img/lecture/memory_hierarchy.drawio.svg" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-memory-hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Memory Hierarchy.
</figcaption>
</figure>
</div>
<ul>
<li>レジスタ (Registers): CPU内部にある最も高速なメモリ</li>
<li>キャッシュ (Cache): (近年では) CPU内部にある高速なメモリ. L1, L2, L3 などのレベルがある. ここまでCPU内部にある.</li>
<li>主記憶 (Main Memory): RAM (Random Access Memory)</li>
<li>補助記憶 (Auxiliary Storage): SSD (Solid State Drive) やHDD (Hard Disk Drive)</li>
</ul>
<p>たとえば, AMDの最新世代のCPUである <a href="https://www.amd.com/en/products/processors/desktops/ryzen/9000-series/amd-ryzen-5-9600.html">Ryzen 5 9600</a> の場合, L1キャッシュは480KB, L2キャッシュは6MB, L3キャッシュは32MBです. レジスタはサイズで表現することはあまりありませんが, ざっくり数百B程度と考えてください. 一方で, 一般にメモリと呼ばれる RAM は8GBから64GB 程度が一般的です. さらに, 一般にストレージとよばれるSSDやHDDは数百GBから数TBの容量があります.</p>
</section>
<section id="計算量の実践" class="level3">
<h3 class="anchored" data-anchor-id="計算量の実践">計算量の実践</h3>
<p>実際にモデルを使って, 計算量を測定してみましょう. 例えば, 以下のような単純なライフサイクルモデルを考えます.</p>
<p><strong>Model</strong></p>
<p><span class="math display">\[
\max_{\{c_t, a_{t+1}\}_{t=0}^{T-1}} \sum_{t=0}^{T-1} \beta^t u(c_t) \\
\quad\text{s.t. } c_t + a_{t+1} = (1+r) a_t + w, \quad a_0 \text{ given}, \quad a_T \ge 0.
\]</span></p>
<p>これは後方帰納法で解くことができます. コードで表すと次の <code>solve!</code> 関数のようになります.</p>
<div id="model-life-cycle" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> My</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@kwdef</span> <span class="kw">struct</span> Model{TF<span class="op">&lt;:</span><span class="dt">AbstractFloat</span>,TI<span class="op">&lt;:</span><span class="dt">Integer</span>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Utility function</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    γ<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">2.0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    β<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">0.96</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    T<span class="op">::</span><span class="dt">Int </span><span class="op">=</span> <span class="fl">10</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prices</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    r<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">0.07</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    w<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">5.0</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid for assets</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    n_a<span class="op">::</span><span class="dt">TI </span><span class="op">=</span> <span class="fl">30</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    a_min<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    a_max<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">4.0</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    a_grid<span class="op">::</span><span class="dt">Vector{TF} </span><span class="op">=</span> <span class="fu">collect</span>(<span class="fu">range</span>(start<span class="op">=</span>a_min, stop<span class="op">=</span>a_max, length<span class="op">=</span>n_a))</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Value function</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    V<span class="op">::</span><span class="dt">Matrix{TF} </span><span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">u</span>(c, m<span class="op">::</span><span class="dt">Model</span>) <span class="op">=</span> <span class="fu">isone</span>(m.γ) ? <span class="fu">log</span>(c) <span class="op">:</span> c<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> m.γ) <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> m.γ)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve!</span>(m<span class="op">::</span><span class="dt">Model</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    (; T, n_a, r, w, β, a_grid) <span class="op">=</span> m</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="op">=</span> T<span class="op">:-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span>, i_a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        utility <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i_a′ <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            V′ <span class="op">=</span> (t <span class="op">==</span> T) ? <span class="fl">0.0</span> <span class="op">:</span> V[i_a′, t<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>            c <span class="op">=</span> (<span class="fl">1</span> <span class="op">+</span> r) <span class="op">*</span> a_grid[i_a] <span class="op">+</span> w <span class="op">-</span> a_grid[i_a′]</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> c <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>                utility <span class="op">=</span> <span class="fu">max</span>(<span class="fu">u</span>(c, m) <span class="op">+</span> β <span class="op">*</span> V′, utility)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        V[i_a, t] <span class="op">=</span> utility</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    m.V <span class="op">.=</span> V</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> <span class="co"># module My</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>時間計算量の数え方として, 四則演算, 比較 (<code>&gt;</code>, <code>max</code> など), 代入, 配列へのアクセスは <span class="math inline">\(O(1)\)</span> とします. すると, 計算回数の主要部は for-loop つまり, <span class="math inline">\(O(n_a^2 T)\)</span> です. メモリ使用量は, 価値関数 <span class="math inline">\(V\)</span> の保存に使用している部分が支配的なので <span class="math inline">\(O(n_a T)\)</span> です. では, <span class="math inline">\(T = 10\)</span> で固定して, <span class="math inline">\(n_a\)</span> を変化させたときの計算時間とメモリ使用量を測定してみましょう.</p>
<p><strong>BenchmarkTools.jl</strong></p>
<p>Juliaでは, <code>BenchmarkTools.jl</code> パッケージを使うと実際の計算時間とメモリ使用量を測定できます.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> My.<span class="fu">solve!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">100</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 10000 samples with 1 evaluation per sample.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">375.875 μs</span> … <span class="ansi-magenta-fg">877.041 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">403.459 μs               </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">409.112 μs</span> ± <span class="ansi-green-fg"> 12.697 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.00% ± 0.00%

                       █<span class="ansi-blue-fg">▂</span>▅▄▄<span class="ansi-green-fg">▂</span>▃▂▂▁▂▁▁▁▁▁▁▁     ▁  ▁▁             ▁
  ▆▁▃▁▁▁▁▁▁▃▃▁▃▁▁▁▃▁▃▁▁█<span class="ansi-blue-fg">█</span>███<span class="ansi-green-fg">█</span>██████████████████████▇▇▆▇▇█████▇█ █
  376 μs<span class="ansi-bright-black-fg">        </span><span class="ansi-bright-black-fg">Histogram: </span><span class="ansi-bright-black-fg ansi-bold">log(</span><span class="ansi-bright-black-fg">frequency</span><span class="ansi-bright-black-fg ansi-bold">)</span><span class="ansi-bright-black-fg"> by time</span>        454 μs <span class="ansi-bold">&lt;</span>

 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">8.08 KiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">3</span>.</pre>
</div>
</div>
</div>
<p><code>@benchmark</code> マクロは上記のように関数の実行時間に合わせて適切な試行回数を自動で決定し, 実行時間の分布を表示してくれます. 基本的には中央値 (median) を見るのが良いでしょう.</p>
<p>メモリ使用量も8.08KiBと表示されています. 今回の配列 <code>V</code> は <code>Float64</code> 型の2次元配列で, <span class="math inline">\(n_a\)</span> 行 <span class="math inline">\(T\)</span> 列なので, メモリ使用量は <span class="math inline">\(8 n_a T\)</span> バイトになります (64bit = 8バイト) . 例えば, <span class="math inline">\(n_a = 100\)</span> のときは <span class="math inline">\(8 \times 100 \times 10 = 8000\)</span> バイトで, 8.08KiB (1KiB = 1024バイト) とほぼ一致しています.</p>
<p>次に <span class="math inline">\(n_a = 1000\)</span> としたときの計算時間を測定してみましょう.</p>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> My.<span class="fu">solve!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">1000</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 125 samples with 1 evaluation per sample.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">40.004 ms</span> … <span class="ansi-magenta-fg"> 41.663 ms</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">40.131 ms               </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">40.157 ms</span> ± <span class="ansi-green-fg">161.254 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.00% ± 0.00%

        ▂▃   █<span class="ansi-blue-fg">▁</span> <span class="ansi-green-fg"> </span>▆                                              
  ▃▁▁▄▆▆███▆▆█<span class="ansi-blue-fg">█</span>▇<span class="ansi-green-fg">▆</span>█▇▄▆▄▃▄▅▆▁▁▁▃▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▃▁▁▁▁▁▁▁▃▁▁▁▁▁▃ ▃
  40 ms<span class="ansi-bright-black-fg">           Histogram: frequency by time</span>         40.6 ms <span class="ansi-bold">&lt;</span>

 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">80.08 KiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">3</span>.</pre>
</div>
</div>
</div>
<p>おおむね計算時間が100倍, メモリ使用量が10倍になっていることがわかります. これは, 計算時間が <span class="math inline">\(O(n_a^2 T)\)</span>, メモリ使用量が <span class="math inline">\(O(n_a T)\)</span> であることと一致しています.</p>
</section>
</section>
<section id="微分" class="level2">
<h2 class="anchored" data-anchor-id="微分">微分</h2>
<p>数値計算の文脈において微分は主に3種類あります.</p>
<ul>
<li>数式微分 (Symbolic Differentiation)</li>
<li>数値微分 (Numerical Differentiation)</li>
<li>自動微分 (Automatic Differentiation)</li>
</ul>
<p>数式微分 (手計算による解析的な微分) が可能な場合は, これが最も高速で効率的ですが, 複雑な関数に対しては, 数値微分や自動微分などで計算する必要があります. 以下では, 次のラグランジアンを例に, それぞれの微分方法を説明します.</p>
<p><span class="math display">\[
\mathcal{L} = \phi \log \left(w(1-l)\right)  + (1-\phi) \frac{l^{1-\gamma}}{1-\gamma}
\]</span></p>
<section id="数式微分-symbolic-differentiation" class="level3">
<h3 class="anchored" data-anchor-id="数式微分-symbolic-differentiation">数式微分 (Symbolic Differentiation)</h3>
<p>いわゆる手計算による微分です. 一階条件を求めると,</p>
<p><span class="math display">\[
\frac{\partial \mathcal{L}}{\partial l} = -\frac{\phi}{1-l} + (1-\phi) l^{-\gamma} = 0.
\]</span></p>
<p><code>Symbolics.jl</code> パッケージを使うと, Julia上で数式微分を行うこともできます.</p>
<div id="symbolic-diff" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Symbolics</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Latexify</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="pp">@variables</span> w l ϕ γ</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>L <span class="op">=</span> ϕ <span class="op">*</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> l)) <span class="op">+</span> (<span class="fl">1</span> <span class="op">-</span> ϕ) <span class="op">*</span> l<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> γ) <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> γ)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>∂l <span class="op">=</span> <span class="fu">Differential</span>(l)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>∂L∂l <span class="op">=</span> <span class="fu">expand_derivatives</span>(<span class="fu">∂l</span>(L))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="fu">latexify</span>(∂L∂l))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><span class="math display">\[\begin{equation}
\frac{ - \phi}{1 - l} + l^{ - \gamma} ~ \left( 1 - \phi \right)
\end{equation}\]</span></p>
</div>
</section>
<section id="数値微分-numerical-differentiation" class="level3">
<h3 class="anchored" data-anchor-id="数値微分-numerical-differentiation">数値微分 (Numerical Differentiation)</h3>
<p><span class="math display">\[
f'(x) = \lim_{\Delta \to 0} \frac{f(x+\Delta) - f(x)}{\Delta}.
\]</span></p>
<p>数値微分は上記の微分の定義を数値的に近似する方法です. 定義通りに行うと, 非常に小さい <span class="math inline">\(d\)</span> (例えば <span class="math inline">\(10^{-9}\)</span> など) を使って, 以下のように近似できます.</p>
<p><span class="math display">\[
f'(x) \approx \frac{f(x+d) - f(x)}{d}.
\]</span></p>
<p>実用上は, 中心差分 (central difference) を使うことが多いです.</p>
<p><span class="math display">\[
f'(x) \approx \frac{f(x+\frac{1}{2}d) - f(x-\frac{1}{2}d)}{d}.
\]</span></p>
<p>Julia では, <code>FiniteDiff.jl</code> パッケージを使うと数値微分ができます.</p>
<div id="numerical-diff" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">FiniteDiff</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(l; w<span class="op">=</span><span class="fl">1</span>., ϕ<span class="op">=</span><span class="fl">0.5</span>, γ<span class="op">=</span><span class="fl">1.5</span>) <span class="op">=</span> ϕ <span class="op">*</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> l)) <span class="op">+</span> (<span class="fl">1</span> <span class="op">-</span> ϕ) <span class="op">*</span> l<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> γ) <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> γ)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_analytical</span>(l; w<span class="op">=</span><span class="fl">1</span>., ϕ<span class="op">=</span><span class="fl">0.5</span>, γ<span class="op">=</span><span class="fl">1.5</span>) <span class="op">=</span> <span class="op">-</span>ϕ <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> l) <span class="op">+</span> (<span class="fl">1</span> <span class="op">-</span> ϕ) <span class="op">*</span> l<span class="op">^</span>(<span class="op">-</span>γ)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_numerical</span>(l; Δ<span class="op">=</span><span class="fl">1e-9</span>) <span class="op">=</span> (<span class="fu">f</span>(l <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> Δ) <span class="op">-</span> <span class="fu">f</span>(l <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> Δ)) <span class="op">/</span> Δ</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_finitediff</span>(l) <span class="op">=</span> FiniteDiff.<span class="fu">finite_difference_derivative</span>(l <span class="op">-&gt;</span> <span class="fu">f</span>(l), l)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-fig-comp-numerical-diff" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_analytical, label<span class="op">=</span><span class="st">"Analytical"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_numerical, label<span class="op">=</span><span class="st">"Numerical"</span>, linestyle<span class="op">=:</span>dash)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_finitediff, label<span class="op">=</span><span class="st">"FiniteDiff.jl"</span>, linestyle<span class="op">=:</span>dot)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="fig-comp-numerical-diff" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="1">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-comp-numerical-diff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="500" height="309" viewbox="0 0 2000 1236">
<defs>
  <clippath id="clip460">
    <rect x="0" y="0" width="2000" height="1236"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip460)" d="M0 1236 L2000 1236 L2000 1.24345e-14 L0 1.24345e-14  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip461">
    <rect x="280" y="47" width="1673" height="1023"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip460)" d="M145.191 1128.61 L1952.76 1128.61 L1952.76 47.2441 L145.191 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip462">
    <rect x="145" y="47" width="1809" height="1082"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="196.348,1128.61 196.348,47.2441 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="683.563,1128.61 683.563,47.2441 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1170.78,1128.61 1170.78,47.2441 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1657.99,1128.61 1657.99,47.2441 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,1052.93 1952.76,1052.93 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,835.407 1952.76,835.407 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,617.88 1952.76,617.88 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,400.352 1952.76,400.352 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,182.824 1952.76,182.824 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,1128.61 1952.76,1128.61 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="196.348,1128.61 196.348,1109.71 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="683.563,1128.61 683.563,1109.71 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1170.78,1128.61 1170.78,1109.71 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1657.99,1128.61 1657.99,1109.71 "></polyline>
<path clip-path="url(#clip460)" d="M174.531 1156.33 Q170.92 1156.33 169.092 1159.89 Q167.286 1163.44 167.286 1170.57 Q167.286 1177.67 169.092 1181.24 Q170.92 1184.78 174.531 1184.78 Q178.166 1184.78 179.971 1181.24 Q181.8 1177.67 181.8 1170.57 Q181.8 1163.44 179.971 1159.89 Q178.166 1156.33 174.531 1156.33 M174.531 1152.63 Q180.342 1152.63 183.397 1157.23 Q186.476 1161.82 186.476 1170.57 Q186.476 1179.29 183.397 1183.9 Q180.342 1188.48 174.531 1188.48 Q168.721 1188.48 165.643 1183.9 Q162.587 1179.29 162.587 1170.57 Q162.587 1161.82 165.643 1157.23 Q168.721 1152.63 174.531 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M194.693 1181.93 L199.578 1181.93 L199.578 1187.81 L194.693 1187.81 L194.693 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M213.79 1183.88 L230.11 1183.88 L230.11 1187.81 L208.165 1187.81 L208.165 1183.88 Q210.827 1181.12 215.411 1176.49 Q220.017 1171.84 221.198 1170.5 Q223.443 1167.97 224.323 1166.24 Q225.226 1164.48 225.226 1162.79 Q225.226 1160.03 223.281 1158.3 Q221.36 1156.56 218.258 1156.56 Q216.059 1156.56 213.605 1157.32 Q211.175 1158.09 208.397 1159.64 L208.397 1154.92 Q211.221 1153.78 213.675 1153.2 Q216.128 1152.63 218.165 1152.63 Q223.536 1152.63 226.73 1155.31 Q229.925 1158 229.925 1162.49 Q229.925 1164.62 229.114 1166.54 Q228.327 1168.44 226.221 1171.03 Q225.642 1171.7 222.54 1174.92 Q219.439 1178.11 213.79 1183.88 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M660.704 1156.33 Q657.093 1156.33 655.264 1159.89 Q653.459 1163.44 653.459 1170.57 Q653.459 1177.67 655.264 1181.24 Q657.093 1184.78 660.704 1184.78 Q664.338 1184.78 666.144 1181.24 Q667.972 1177.67 667.972 1170.57 Q667.972 1163.44 666.144 1159.89 Q664.338 1156.33 660.704 1156.33 M660.704 1152.63 Q666.514 1152.63 669.57 1157.23 Q672.648 1161.82 672.648 1170.57 Q672.648 1179.29 669.57 1183.9 Q666.514 1188.48 660.704 1188.48 Q654.894 1188.48 651.815 1183.9 Q648.76 1179.29 648.76 1170.57 Q648.76 1161.82 651.815 1157.23 Q654.894 1152.63 660.704 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M680.866 1181.93 L685.75 1181.93 L685.75 1187.81 L680.866 1187.81 L680.866 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M708.782 1157.32 L696.977 1175.77 L708.782 1175.77 L708.782 1157.32 M707.556 1153.25 L713.435 1153.25 L713.435 1175.77 L718.366 1175.77 L718.366 1179.66 L713.435 1179.66 L713.435 1187.81 L708.782 1187.81 L708.782 1179.66 L693.181 1179.66 L693.181 1175.15 L707.556 1153.25 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1148.08 1156.33 Q1144.47 1156.33 1142.64 1159.89 Q1140.83 1163.44 1140.83 1170.57 Q1140.83 1177.67 1142.64 1181.24 Q1144.47 1184.78 1148.08 1184.78 Q1151.71 1184.78 1153.52 1181.24 Q1155.35 1177.67 1155.35 1170.57 Q1155.35 1163.44 1153.52 1159.89 Q1151.71 1156.33 1148.08 1156.33 M1148.08 1152.63 Q1153.89 1152.63 1156.95 1157.23 Q1160.02 1161.82 1160.02 1170.57 Q1160.02 1179.29 1156.95 1183.9 Q1153.89 1188.48 1148.08 1188.48 Q1142.27 1188.48 1139.19 1183.9 Q1136.14 1179.29 1136.14 1170.57 Q1136.14 1161.82 1139.19 1157.23 Q1142.27 1152.63 1148.08 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1168.24 1181.93 L1173.13 1181.93 L1173.13 1187.81 L1168.24 1187.81 L1168.24 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1193.89 1168.67 Q1190.74 1168.67 1188.89 1170.82 Q1187.06 1172.97 1187.06 1176.72 Q1187.06 1180.45 1188.89 1182.63 Q1190.74 1184.78 1193.89 1184.78 Q1197.04 1184.78 1198.87 1182.63 Q1200.72 1180.45 1200.72 1176.72 Q1200.72 1172.97 1198.87 1170.82 Q1197.04 1168.67 1193.89 1168.67 M1203.17 1154.01 L1203.17 1158.27 Q1201.41 1157.44 1199.61 1157 Q1197.83 1156.56 1196.07 1156.56 Q1191.44 1156.56 1188.98 1159.69 Q1186.55 1162.81 1186.21 1169.13 Q1187.57 1167.12 1189.63 1166.05 Q1191.69 1164.96 1194.17 1164.96 Q1199.38 1164.96 1202.39 1168.13 Q1205.42 1171.28 1205.42 1176.72 Q1205.42 1182.05 1202.27 1185.26 Q1199.12 1188.48 1193.89 1188.48 Q1187.89 1188.48 1184.72 1183.9 Q1181.55 1179.29 1181.55 1170.57 Q1181.55 1162.37 1185.44 1157.51 Q1189.33 1152.63 1195.88 1152.63 Q1197.64 1152.63 1199.42 1152.97 Q1201.23 1153.32 1203.17 1154.01 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1635.42 1156.33 Q1631.81 1156.33 1629.98 1159.89 Q1628.18 1163.44 1628.18 1170.57 Q1628.18 1177.67 1629.98 1181.24 Q1631.81 1184.78 1635.42 1184.78 Q1639.06 1184.78 1640.86 1181.24 Q1642.69 1177.67 1642.69 1170.57 Q1642.69 1163.44 1640.86 1159.89 Q1639.06 1156.33 1635.42 1156.33 M1635.42 1152.63 Q1641.23 1152.63 1644.29 1157.23 Q1647.37 1161.82 1647.37 1170.57 Q1647.37 1179.29 1644.29 1183.9 Q1641.23 1188.48 1635.42 1188.48 Q1629.61 1188.48 1626.53 1183.9 Q1623.48 1179.29 1623.48 1170.57 Q1623.48 1161.82 1626.53 1157.23 Q1629.61 1152.63 1635.42 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1655.58 1181.93 L1660.47 1181.93 L1660.47 1187.81 L1655.58 1187.81 L1655.58 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1680.65 1171.4 Q1677.32 1171.4 1675.4 1173.18 Q1673.5 1174.96 1673.5 1178.09 Q1673.5 1181.21 1675.4 1183 Q1677.32 1184.78 1680.65 1184.78 Q1683.99 1184.78 1685.91 1183 Q1687.83 1181.19 1687.83 1178.09 Q1687.83 1174.96 1685.91 1173.18 Q1684.01 1171.4 1680.65 1171.4 M1675.98 1169.41 Q1672.97 1168.67 1671.28 1166.61 Q1669.61 1164.55 1669.61 1161.58 Q1669.61 1157.44 1672.55 1155.03 Q1675.51 1152.63 1680.65 1152.63 Q1685.82 1152.63 1688.75 1155.03 Q1691.69 1157.44 1691.69 1161.58 Q1691.69 1164.55 1690 1166.61 Q1688.34 1168.67 1685.35 1169.41 Q1688.73 1170.2 1690.61 1172.49 Q1692.5 1174.78 1692.5 1178.09 Q1692.5 1183.11 1689.43 1185.8 Q1686.37 1188.48 1680.65 1188.48 Q1674.94 1188.48 1671.86 1185.8 Q1668.8 1183.11 1668.8 1178.09 Q1668.8 1174.78 1670.7 1172.49 Q1672.6 1170.2 1675.98 1169.41 M1674.26 1162.02 Q1674.26 1164.71 1675.93 1166.21 Q1677.62 1167.72 1680.65 1167.72 Q1683.66 1167.72 1685.35 1166.21 Q1687.07 1164.71 1687.07 1162.02 Q1687.07 1159.34 1685.35 1157.83 Q1683.66 1156.33 1680.65 1156.33 Q1677.62 1156.33 1675.93 1157.83 Q1674.26 1159.34 1674.26 1162.02 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,1128.61 145.191,47.2441 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,1052.93 164.089,1052.93 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,835.407 164.089,835.407 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,617.88 164.089,617.88 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,400.352 164.089,400.352 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,182.824 164.089,182.824 "></polyline>
<path clip-path="url(#clip460)" d="M52.9921 1053.39 L82.6679 1053.39 L82.6679 1057.32 L52.9921 1057.32 L52.9921 1053.39 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M105.608 1039.73 L93.8021 1058.18 L105.608 1058.18 L105.608 1039.73 M104.381 1035.65 L110.26 1035.65 L110.26 1058.18 L115.191 1058.18 L115.191 1062.07 L110.26 1062.07 L110.26 1070.21 L105.608 1070.21 L105.608 1062.07 L90.0058 1062.07 L90.0058 1057.55 L104.381 1035.65 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M55.0754 835.859 L84.7512 835.859 L84.7512 839.794 L55.0754 839.794 L55.0754 835.859 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M98.8715 848.752 L115.191 848.752 L115.191 852.687 L93.2465 852.687 L93.2465 848.752 Q95.9086 845.998 100.492 841.368 Q105.098 836.715 106.279 835.373 Q108.524 832.849 109.404 831.113 Q110.307 829.354 110.307 827.664 Q110.307 824.91 108.362 823.174 Q106.441 821.438 103.339 821.438 Q101.14 821.438 98.6863 822.201 Q96.2558 822.965 93.478 824.516 L93.478 819.794 Q96.3021 818.66 98.7558 818.081 Q101.209 817.502 103.246 817.502 Q108.617 817.502 111.811 820.188 Q115.006 822.873 115.006 827.363 Q115.006 829.493 114.196 831.414 Q113.408 833.312 111.302 835.905 Q110.723 836.576 107.621 839.794 Q104.52 842.988 98.8715 848.752 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M103.246 603.678 Q99.6354 603.678 97.8067 607.243 Q96.0012 610.785 96.0012 617.914 Q96.0012 625.021 97.8067 628.586 Q99.6354 632.127 103.246 632.127 Q106.881 632.127 108.686 628.586 Q110.515 625.021 110.515 617.914 Q110.515 610.785 108.686 607.243 Q106.881 603.678 103.246 603.678 M103.246 599.975 Q109.057 599.975 112.112 604.581 Q115.191 609.164 115.191 617.914 Q115.191 626.641 112.112 631.248 Q109.057 635.831 103.246 635.831 Q97.4363 635.831 94.3576 631.248 Q91.3021 626.641 91.3021 617.914 Q91.3021 609.164 94.3576 604.581 Q97.4363 599.975 103.246 599.975 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M98.8715 413.697 L115.191 413.697 L115.191 417.632 L93.2465 417.632 L93.2465 413.697 Q95.9086 410.942 100.492 406.313 Q105.098 401.66 106.279 400.317 Q108.524 397.794 109.404 396.058 Q110.307 394.299 110.307 392.609 Q110.307 389.854 108.362 388.118 Q106.441 386.382 103.339 386.382 Q101.14 386.382 98.6863 387.146 Q96.2558 387.91 93.478 389.461 L93.478 384.739 Q96.3021 383.604 98.7558 383.026 Q101.209 382.447 103.246 382.447 Q108.617 382.447 111.811 385.132 Q115.006 387.817 115.006 392.308 Q115.006 394.438 114.196 396.359 Q113.408 398.257 111.302 400.85 Q110.723 401.521 107.621 404.739 Q104.52 407.933 98.8715 413.697 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M105.608 169.618 L93.8021 188.067 L105.608 188.067 L105.608 169.618 M104.381 165.544 L110.26 165.544 L110.26 188.067 L115.191 188.067 L115.191 191.956 L110.26 191.956 L110.26 200.104 L105.608 200.104 L105.608 191.956 L90.0058 191.956 L90.0058 187.442 L104.381 165.544 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip462)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="196.348,77.8489 220.709,121.617 245.07,160.588 269.431,195.488 293.791,226.907 318.152,255.334 342.513,281.17 366.873,304.753 391.234,326.367 415.595,346.251 439.956,364.61 464.316,381.621 488.677,397.433 513.038,412.178 537.398,425.97 561.759,438.909 586.12,451.083 610.481,462.57 634.841,473.437 659.202,483.746 683.563,493.553 707.923,502.905 732.284,511.849 756.645,520.422 781.006,528.663 805.366,536.605 829.727,544.279 854.088,551.712 878.448,558.932 902.809,565.963 927.17,572.828 951.531,579.55 975.891,586.148 1000.25,592.644 1024.61,599.056 1048.97,605.404 1073.33,611.706 1097.69,617.98 1122.06,624.245 1146.42,630.52 1170.78,636.823 1195.14,643.175 1219.5,649.595 1243.86,656.104 1268.22,662.726 1292.58,669.484 1316.94,676.403 1341.3,683.512 1365.66,690.841 1390.02,698.424 1414.38,706.297 1438.74,714.503 1463.11,723.087 1487.47,732.103 1511.83,741.612 1536.19,751.681 1560.55,762.392 1584.91,773.837 1609.27,786.127 1633.63,799.393 1657.99,813.788 1682.35,829.502 1706.71,846.764 1731.07,865.855 1755.43,887.129 1779.79,911.031 1804.16,938.134 1828.52,969.187 1852.88,1005.19 1877.24,1047.49 1901.6,1098.01 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" stroke-dasharray="16, 10" points="196.348,77.8488 220.709,121.617 245.07,160.588 269.431,195.488 293.791,226.907 318.152,255.334 342.513,281.17 366.873,304.753 391.234,326.367 415.595,346.251 439.956,364.61 464.316,381.621 488.677,397.433 513.038,412.178 537.398,425.97 561.759,438.909 586.12,451.083 610.481,462.57 634.841,473.437 659.202,483.746 683.563,493.553 707.923,502.905 732.284,511.849 756.645,520.422 781.006,528.663 805.366,536.605 829.727,544.279 854.088,551.712 878.448,558.932 902.809,565.963 927.17,572.828 951.531,579.55 975.891,586.148 1000.25,592.644 1024.61,599.056 1048.97,605.404 1073.33,611.706 1097.69,617.98 1122.06,624.245 1146.42,630.52 1170.78,636.823 1195.14,643.175 1219.5,649.595 1243.86,656.104 1268.22,662.726 1292.58,669.484 1316.94,676.403 1341.3,683.512 1365.66,690.841 1390.02,698.424 1414.38,706.297 1438.74,714.503 1463.11,723.087 1487.47,732.104 1511.83,741.612 1536.19,751.681 1560.55,762.392 1584.91,773.837 1609.27,786.127 1633.63,799.393 1657.99,813.788 1682.35,829.502 1706.71,846.764 1731.07,865.855 1755.43,887.129 1779.79,911.031 1804.16,938.134 1828.52,969.187 1852.88,1005.19 1877.24,1047.49 1901.6,1098.01 "></polyline>
<polyline clip-path="url(#clip462)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" stroke-dasharray="2, 4" points="196.348,77.8489 220.709,121.617 245.07,160.588 269.431,195.488 293.791,226.907 318.152,255.334 342.513,281.17 366.873,304.753 391.234,326.367 415.595,346.251 439.956,364.61 464.316,381.621 488.677,397.433 513.038,412.178 537.398,425.97 561.759,438.909 586.12,451.083 610.481,462.57 634.841,473.437 659.202,483.746 683.563,493.553 707.923,502.905 732.284,511.849 756.645,520.422 781.006,528.663 805.366,536.605 829.727,544.279 854.088,551.712 878.448,558.932 902.809,565.963 927.17,572.828 951.531,579.55 975.891,586.148 1000.25,592.644 1024.61,599.056 1048.97,605.404 1073.33,611.706 1097.69,617.98 1122.06,624.245 1146.42,630.52 1170.78,636.823 1195.14,643.175 1219.5,649.595 1243.86,656.104 1268.22,662.726 1292.58,669.484 1316.94,676.403 1341.3,683.512 1365.66,690.841 1390.02,698.424 1414.38,706.297 1438.74,714.503 1463.11,723.087 1487.47,732.103 1511.83,741.612 1536.19,751.681 1560.55,762.392 1584.91,773.837 1609.27,786.127 1633.63,799.393 1657.99,813.788 1682.35,829.502 1706.71,846.764 1731.07,865.855 1755.43,887.129 1779.79,911.031 1804.16,938.134 1828.52,969.187 1852.88,1005.19 1877.24,1047.49 1901.6,1098.01 "></polyline>
<path clip-path="url(#clip460)" d="M1471.86 290.65 L1892.5 290.65 L1892.5 83.2896 L1471.86 83.2896  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip460)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1471.86,290.65 1892.5,290.65 1892.5,83.2896 1471.86,83.2896 1471.86,290.65 "></polyline>
<polyline clip-path="url(#clip460)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1491.95,135.13 1612.45,135.13 "></polyline>
<path clip-path="url(#clip460)" d="M1648.37 122.456 L1642.03 139.655 L1654.74 139.655 L1648.37 122.456 M1645.73 117.85 L1651.03 117.85 L1664.2 152.41 L1659.34 152.41 L1656.19 143.544 L1640.62 143.544 L1637.47 152.41 L1632.54 152.41 L1645.73 117.85 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1690.62 136.762 L1690.62 152.41 L1686.36 152.41 L1686.36 136.9 Q1686.36 133.22 1684.92 131.391 Q1683.49 129.563 1680.62 129.563 Q1677.17 129.563 1675.18 131.762 Q1673.18 133.961 1673.18 137.757 L1673.18 152.41 L1668.9 152.41 L1668.9 126.484 L1673.18 126.484 L1673.18 130.512 Q1674.71 128.174 1676.77 127.016 Q1678.86 125.859 1681.56 125.859 Q1686.03 125.859 1688.32 128.637 Q1690.62 131.391 1690.62 136.762 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1710.89 139.377 Q1705.73 139.377 1703.74 140.558 Q1701.75 141.738 1701.75 144.586 Q1701.75 146.854 1703.23 148.197 Q1704.74 149.516 1707.3 149.516 Q1710.85 149.516 1712.98 147.016 Q1715.13 144.493 1715.13 140.326 L1715.13 139.377 L1710.89 139.377 M1719.39 137.618 L1719.39 152.41 L1715.13 152.41 L1715.13 148.474 Q1713.67 150.836 1711.49 151.97 Q1709.32 153.081 1706.17 153.081 Q1702.19 153.081 1699.83 150.859 Q1697.49 148.613 1697.49 144.863 Q1697.49 140.488 1700.41 138.266 Q1703.35 136.044 1709.16 136.044 L1715.13 136.044 L1715.13 135.627 Q1715.13 132.688 1713.18 131.09 Q1711.26 129.47 1707.77 129.47 Q1705.55 129.47 1703.44 130.002 Q1701.33 130.535 1699.39 131.6 L1699.39 127.664 Q1701.73 126.762 1703.93 126.322 Q1706.12 125.859 1708.21 125.859 Q1713.83 125.859 1716.61 128.776 Q1719.39 131.692 1719.39 137.618 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1728.16 116.391 L1732.42 116.391 L1732.42 152.41 L1728.16 152.41 L1728.16 116.391 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1752.12 154.817 Q1750.31 159.447 1748.6 160.859 Q1746.89 162.271 1744.02 162.271 L1740.61 162.271 L1740.61 158.706 L1743.11 158.706 Q1744.87 158.706 1745.85 157.873 Q1746.82 157.039 1748 153.937 L1748.76 151.993 L1738.28 126.484 L1742.79 126.484 L1750.89 146.762 L1758.99 126.484 L1763.51 126.484 L1752.12 154.817 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1773.6 119.123 L1773.6 126.484 L1782.37 126.484 L1782.37 129.794 L1773.6 129.794 L1773.6 143.868 Q1773.6 147.039 1774.46 147.942 Q1775.34 148.845 1778 148.845 L1782.37 148.845 L1782.37 152.41 L1778 152.41 Q1773.07 152.41 1771.19 150.581 Q1769.32 148.729 1769.32 143.868 L1769.32 129.794 L1766.19 129.794 L1766.19 126.484 L1769.32 126.484 L1769.32 119.123 L1773.6 119.123 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1787.98 126.484 L1792.23 126.484 L1792.23 152.41 L1787.98 152.41 L1787.98 126.484 M1787.98 116.391 L1792.23 116.391 L1792.23 121.785 L1787.98 121.785 L1787.98 116.391 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1819.8 127.479 L1819.8 131.461 Q1818 130.465 1816.17 129.979 Q1814.36 129.47 1812.51 129.47 Q1808.37 129.47 1806.08 132.109 Q1803.79 134.725 1803.79 139.47 Q1803.79 144.215 1806.08 146.854 Q1808.37 149.47 1812.51 149.47 Q1814.36 149.47 1816.17 148.984 Q1818 148.474 1819.8 147.479 L1819.8 151.414 Q1818.02 152.248 1816.1 152.664 Q1814.2 153.081 1812.05 153.081 Q1806.19 153.081 1802.74 149.4 Q1799.3 145.72 1799.3 139.47 Q1799.3 133.127 1802.77 129.493 Q1806.26 125.859 1812.33 125.859 Q1814.29 125.859 1816.17 126.276 Q1818.04 126.669 1819.8 127.479 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1838.99 139.377 Q1833.83 139.377 1831.84 140.558 Q1829.85 141.738 1829.85 144.586 Q1829.85 146.854 1831.33 148.197 Q1832.84 149.516 1835.41 149.516 Q1838.95 149.516 1841.08 147.016 Q1843.23 144.493 1843.23 140.326 L1843.23 139.377 L1838.99 139.377 M1847.49 137.618 L1847.49 152.41 L1843.23 152.41 L1843.23 148.474 Q1841.77 150.836 1839.6 151.97 Q1837.42 153.081 1834.27 153.081 Q1830.29 153.081 1827.93 150.859 Q1825.59 148.613 1825.59 144.863 Q1825.59 140.488 1828.51 138.266 Q1831.45 136.044 1837.26 136.044 L1843.23 136.044 L1843.23 135.627 Q1843.23 132.688 1841.29 131.09 Q1839.36 129.47 1835.87 129.47 Q1833.65 129.47 1831.54 130.002 Q1829.43 130.535 1827.49 131.6 L1827.49 127.664 Q1829.83 126.762 1832.03 126.322 Q1834.23 125.859 1836.31 125.859 Q1841.93 125.859 1844.71 128.776 Q1847.49 131.692 1847.49 137.618 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1856.26 116.391 L1860.52 116.391 L1860.52 152.41 L1856.26 152.41 L1856.26 116.391 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip460)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" stroke-dasharray="16, 10" points="1491.95,186.97 1612.45,186.97 "></polyline>
<path clip-path="url(#clip460)" d="M1632.54 169.69 L1638.83 169.69 L1654.16 198.602 L1654.16 169.69 L1658.69 169.69 L1658.69 204.25 L1652.4 204.25 L1637.07 175.338 L1637.07 204.25 L1632.54 204.25 L1632.54 169.69 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1667.37 194.018 L1667.37 178.324 L1671.63 178.324 L1671.63 193.856 Q1671.63 197.537 1673.07 199.389 Q1674.5 201.217 1677.37 201.217 Q1680.82 201.217 1682.81 199.018 Q1684.83 196.819 1684.83 193.023 L1684.83 178.324 L1689.09 178.324 L1689.09 204.25 L1684.83 204.25 L1684.83 200.268 Q1683.28 202.629 1681.22 203.787 Q1679.18 204.921 1676.47 204.921 Q1672 204.921 1669.69 202.143 Q1667.37 199.365 1667.37 194.018 M1678.09 177.699 L1678.09 177.699 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1718.05 183.301 Q1719.64 180.43 1721.86 179.065 Q1724.09 177.699 1727.1 177.699 Q1731.15 177.699 1733.35 180.546 Q1735.55 183.37 1735.55 188.602 L1735.55 204.25 L1731.26 204.25 L1731.26 188.74 Q1731.26 185.014 1729.94 183.208 Q1728.62 181.403 1725.92 181.403 Q1722.61 181.403 1720.68 183.602 Q1718.76 185.801 1718.76 189.597 L1718.76 204.25 L1714.48 204.25 L1714.48 188.74 Q1714.48 184.99 1713.16 183.208 Q1711.84 181.403 1709.09 181.403 Q1705.82 181.403 1703.9 183.625 Q1701.98 185.824 1701.98 189.597 L1701.98 204.25 L1697.7 204.25 L1697.7 178.324 L1701.98 178.324 L1701.98 182.352 Q1703.44 179.967 1705.48 178.833 Q1707.51 177.699 1710.31 177.699 Q1713.14 177.699 1715.11 179.134 Q1717.1 180.569 1718.05 183.301 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1766.22 190.222 L1766.22 192.305 L1746.63 192.305 Q1746.91 196.703 1749.27 199.018 Q1751.66 201.31 1755.89 201.31 Q1758.35 201.31 1760.64 200.708 Q1762.95 200.106 1765.22 198.902 L1765.22 202.93 Q1762.93 203.902 1760.52 204.412 Q1758.11 204.921 1755.64 204.921 Q1749.43 204.921 1745.8 201.31 Q1742.19 197.699 1742.19 191.541 Q1742.19 185.176 1745.61 181.449 Q1749.06 177.699 1754.9 177.699 Q1760.13 177.699 1763.16 181.078 Q1766.22 184.435 1766.22 190.222 M1761.96 188.972 Q1761.91 185.477 1759.99 183.393 Q1758.09 181.31 1754.94 181.31 Q1751.38 181.31 1749.23 183.324 Q1747.1 185.338 1746.77 188.995 L1761.96 188.972 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1788.23 182.305 Q1787.51 181.889 1786.66 181.703 Q1785.82 181.495 1784.8 181.495 Q1781.19 181.495 1779.25 183.856 Q1777.33 186.194 1777.33 190.592 L1777.33 204.25 L1773.05 204.25 L1773.05 178.324 L1777.33 178.324 L1777.33 182.352 Q1778.67 179.991 1780.82 178.856 Q1782.98 177.699 1786.05 177.699 Q1786.49 177.699 1787.03 177.768 Q1787.56 177.815 1788.21 177.93 L1788.23 182.305 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1792.7 178.324 L1796.96 178.324 L1796.96 204.25 L1792.7 204.25 L1792.7 178.324 M1792.7 168.231 L1796.96 168.231 L1796.96 173.625 L1792.7 173.625 L1792.7 168.231 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1824.53 179.319 L1824.53 183.301 Q1822.72 182.305 1820.89 181.819 Q1819.09 181.31 1817.23 181.31 Q1813.09 181.31 1810.8 183.949 Q1808.51 186.565 1808.51 191.31 Q1808.51 196.055 1810.8 198.694 Q1813.09 201.31 1817.23 201.31 Q1819.09 201.31 1820.89 200.824 Q1822.72 200.314 1824.53 199.319 L1824.53 203.254 Q1822.74 204.088 1820.82 204.504 Q1818.92 204.921 1816.77 204.921 Q1810.92 204.921 1807.47 201.24 Q1804.02 197.56 1804.02 191.31 Q1804.02 184.967 1807.49 181.333 Q1810.98 177.699 1817.05 177.699 Q1819.02 177.699 1820.89 178.116 Q1822.77 178.509 1824.53 179.319 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1843.72 191.217 Q1838.55 191.217 1836.56 192.398 Q1834.57 193.578 1834.57 196.426 Q1834.57 198.694 1836.05 200.037 Q1837.56 201.356 1840.13 201.356 Q1843.67 201.356 1845.8 198.856 Q1847.95 196.333 1847.95 192.166 L1847.95 191.217 L1843.72 191.217 M1852.21 189.458 L1852.21 204.25 L1847.95 204.25 L1847.95 200.314 Q1846.49 202.676 1844.32 203.81 Q1842.14 204.921 1838.99 204.921 Q1835.01 204.921 1832.65 202.699 Q1830.31 200.453 1830.31 196.703 Q1830.31 192.328 1833.23 190.106 Q1836.17 187.884 1841.98 187.884 L1847.95 187.884 L1847.95 187.467 Q1847.95 184.528 1846.01 182.93 Q1844.09 181.31 1840.59 181.31 Q1838.37 181.31 1836.26 181.842 Q1834.16 182.375 1832.21 183.44 L1832.21 179.504 Q1834.55 178.602 1836.75 178.162 Q1838.95 177.699 1841.03 177.699 Q1846.66 177.699 1849.43 180.616 Q1852.21 183.532 1852.21 189.458 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1860.98 168.231 L1865.24 168.231 L1865.24 204.25 L1860.98 204.25 L1860.98 168.231 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip460)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" stroke-dasharray="2, 4" points="1491.95,238.81 1612.45,238.81 "></polyline>
<path clip-path="url(#clip460)" d="M1632.54 221.53 L1652.4 221.53 L1652.4 225.465 L1637.21 225.465 L1637.21 235.65 L1650.92 235.65 L1650.92 239.585 L1637.21 239.585 L1637.21 256.09 L1632.54 256.09 L1632.54 221.53 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1656.17 230.164 L1660.43 230.164 L1660.43 256.09 L1656.17 256.09 L1656.17 230.164 M1656.17 220.071 L1660.43 220.071 L1660.43 225.465 L1656.17 225.465 L1656.17 220.071 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1690.89 240.442 L1690.89 256.09 L1686.63 256.09 L1686.63 240.58 Q1686.63 236.9 1685.2 235.071 Q1683.76 233.243 1680.89 233.243 Q1677.44 233.243 1675.45 235.442 Q1673.46 237.641 1673.46 241.437 L1673.46 256.09 L1669.18 256.09 L1669.18 230.164 L1673.46 230.164 L1673.46 234.192 Q1674.99 231.854 1677.05 230.696 Q1679.13 229.539 1681.84 229.539 Q1686.31 229.539 1688.6 232.317 Q1690.89 235.071 1690.89 240.442 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1699.39 230.164 L1703.65 230.164 L1703.65 256.09 L1699.39 256.09 L1699.39 230.164 M1699.39 220.071 L1703.65 220.071 L1703.65 225.465 L1699.39 225.465 L1699.39 220.071 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1716.77 222.803 L1716.77 230.164 L1725.55 230.164 L1725.55 233.474 L1716.77 233.474 L1716.77 247.548 Q1716.77 250.719 1717.63 251.622 Q1718.51 252.525 1721.17 252.525 L1725.55 252.525 L1725.55 256.09 L1721.17 256.09 Q1716.24 256.09 1714.36 254.261 Q1712.49 252.409 1712.49 247.548 L1712.49 233.474 L1709.36 233.474 L1709.36 230.164 L1712.49 230.164 L1712.49 222.803 L1716.77 222.803 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1753.32 242.062 L1753.32 244.145 L1733.74 244.145 Q1734.02 248.543 1736.38 250.858 Q1738.76 253.15 1743 253.15 Q1745.45 253.15 1747.74 252.548 Q1750.06 251.946 1752.33 250.742 L1752.33 254.77 Q1750.04 255.742 1747.63 256.252 Q1745.22 256.761 1742.74 256.761 Q1736.54 256.761 1732.91 253.15 Q1729.3 249.539 1729.3 243.381 Q1729.3 237.016 1732.72 233.289 Q1736.17 229.539 1742 229.539 Q1747.24 229.539 1750.27 232.918 Q1753.32 236.275 1753.32 242.062 M1749.06 240.812 Q1749.02 237.317 1747.1 235.233 Q1745.2 233.15 1742.05 233.15 Q1738.49 233.15 1736.33 235.164 Q1734.2 237.178 1733.88 240.835 L1749.06 240.812 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1765.17 225.372 L1765.17 252.247 L1770.82 252.247 Q1777.98 252.247 1781.29 249.006 Q1784.62 245.766 1784.62 238.775 Q1784.62 231.831 1781.29 228.613 Q1777.98 225.372 1770.82 225.372 L1765.17 225.372 M1760.5 221.53 L1770.11 221.53 Q1780.15 221.53 1784.85 225.719 Q1789.55 229.886 1789.55 238.775 Q1789.55 247.71 1784.83 251.9 Q1780.11 256.09 1770.11 256.09 L1760.5 256.09 L1760.5 221.53 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1796.82 230.164 L1801.08 230.164 L1801.08 256.09 L1796.82 256.09 L1796.82 230.164 M1796.82 220.071 L1801.08 220.071 L1801.08 225.465 L1796.82 225.465 L1796.82 220.071 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1823.11 220.071 L1823.11 223.613 L1819.04 223.613 Q1816.75 223.613 1815.85 224.539 Q1814.97 225.465 1814.97 227.872 L1814.97 230.164 L1821.98 230.164 L1821.98 233.474 L1814.97 233.474 L1814.97 256.09 L1810.68 256.09 L1810.68 233.474 L1806.61 233.474 L1806.61 230.164 L1810.68 230.164 L1810.68 228.358 Q1810.68 224.03 1812.7 222.062 Q1814.71 220.071 1819.09 220.071 L1823.11 220.071 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1839.8 220.071 L1839.8 223.613 L1835.73 223.613 Q1833.44 223.613 1832.54 224.539 Q1831.66 225.465 1831.66 227.872 L1831.66 230.164 L1838.67 230.164 L1838.67 233.474 L1831.66 233.474 L1831.66 256.09 L1827.37 256.09 L1827.37 233.474 L1823.3 233.474 L1823.3 230.164 L1827.37 230.164 L1827.37 228.358 Q1827.37 224.03 1829.39 222.062 Q1831.4 220.071 1835.78 220.071 L1839.8 220.071 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1840.52 250.21 L1845.41 250.21 L1845.41 256.09 L1840.52 256.09 L1840.52 250.21 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1854.99 230.164 L1859.25 230.164 L1859.25 256.553 Q1859.25 261.506 1857.35 263.728 Q1855.48 265.951 1851.29 265.951 L1849.67 265.951 L1849.67 262.34 L1850.8 262.34 Q1853.23 262.34 1854.11 261.205 Q1854.99 260.094 1854.99 256.553 L1854.99 230.164 M1854.99 220.071 L1859.25 220.071 L1859.25 225.465 L1854.99 225.465 L1854.99 220.071 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip460)" d="M1868.16 220.071 L1872.42 220.071 L1872.42 256.09 L1868.16 256.09 L1868.16 220.071 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path></svg>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-comp-numerical-diff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Comparison of analytical and numerical derivatives.
</figcaption>
</figure>
</div>
</div>
</section>
<section id="自動微分-automatic-differentiation" class="level3">
<h3 class="anchored" data-anchor-id="自動微分-automatic-differentiation">自動微分 (Automatic Differentiation)</h3>
<p>数値微分はとてもシンプルな実装ですが, <span class="math inline">\(d\)</span> の選び方によっては精度が悪くなる可能性があります. より高い精度を求める場合は, 自動微分を用いることができます. 自動微分は, 関数を基本的な演算 (多項式, 三角関数, 対数関数など) の組み合わせとして分解し, 各基本演算の微分を連鎖律に基づいて計算する方法です. これは, 数式微分を数値的に実行するようなイメージです.</p>
<p><strong>順伝播と逆伝播</strong></p>
<p><span class="math display">\[
\frac{dy}{dx} = \frac{dy}{du} \cdot \frac{du}{dx}
\]</span></p>
<ul>
<li>順伝播 (forward mode): 入力から出力に向かって微分を計算する方法.
<ul>
<li><span class="math inline">\(\frac{du}{dx}\)</span> を計算し, それを用いて <span class="math inline">\(\frac{dy}{du}\)</span> を計算する.</li>
</ul></li>
<li>逆伝播 (reverse mode): 出力から入力に向かって微分を計算する方法.
<ul>
<li><span class="math inline">\(\frac{dy}{du}\)</span> を計算し, それを用いて <span class="math inline">\(\frac{du}{dx}\)</span> を計算する.</li>
</ul></li>
</ul>
<p>一般に <span class="math inline">\(f: \mathbb{R}^m \to \mathbb{R}^n\)</span> に対して, <span class="math inline">\(m &gt; n\)</span> の場合は逆伝播が効率的であり, <span class="math inline">\(m &lt; n\)</span> の場合は順伝播が効率的です. 例えば, ニューラルネットワークでは, 多数のパラメータ (重み) を持つモデルに対して, 単一の損失関数を最小化するために逆伝播がよく使われます.</p>
<p>順伝播の効率的な実装は双対数 (dual numbers) を用いて行えることが知られています. 一方, 逆伝播の効率的な実装は難しく, 様々な手法が提案されている状況です. 詳しくは, <span class="citation" data-cites="perla">Perla, Sargent, and Stachurski (<a href="#ref-perla" role="doc-biblioref">n.d.</a>)</span> の<a href="https://julia.quantecon.org/more_julia/optimization_solver_packages.html">9.2節</a> を参照してください.</p>
<p>Julia では, <code>ForwardDiff.jl</code> パッケージを使うと順伝播の自動微分ができます.</p>
<div id="automatic-diff" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ForwardDiff</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_forwarddiff</span>(l) <span class="op">=</span> ForwardDiff.<span class="fu">derivative</span>(l <span class="op">-&gt;</span> <span class="fu">f</span>(l), l)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-fig-comp-automatic-diff" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_analytical, label<span class="op">=</span><span class="st">"Analytical"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_forwarddiff, label<span class="op">=</span><span class="st">"ForwardDiff.jl"</span>, linestyle<span class="op">=:</span>dash)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="fig-comp-automatic-diff" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="1">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-comp-automatic-diff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="500" height="309" viewbox="0 0 2000 1236">
<defs>
  <clippath id="clip520">
    <rect x="0" y="0" width="2000" height="1236"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip520)" d="M0 1236 L2000 1236 L2000 1.24345e-14 L0 1.24345e-14  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip521">
    <rect x="145" y="47" width="1809" height="1082"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip520)" d="M145.191 1128.61 L1952.76 1128.61 L1952.76 47.2441 L145.191 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="196.348,1128.61 196.348,47.2441 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="683.563,1128.61 683.563,47.2441 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1170.78,1128.61 1170.78,47.2441 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1657.99,1128.61 1657.99,47.2441 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,1052.94 1952.76,1052.94 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,835.407 1952.76,835.407 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,617.88 1952.76,617.88 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,400.352 1952.76,400.352 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="145.191,182.824 1952.76,182.824 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,1128.61 1952.76,1128.61 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="196.348,1128.61 196.348,1109.71 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="683.563,1128.61 683.563,1109.71 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1170.78,1128.61 1170.78,1109.71 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1657.99,1128.61 1657.99,1109.71 "></polyline>
<path clip-path="url(#clip520)" d="M174.531 1156.33 Q170.92 1156.33 169.092 1159.89 Q167.286 1163.44 167.286 1170.57 Q167.286 1177.67 169.092 1181.24 Q170.92 1184.78 174.531 1184.78 Q178.166 1184.78 179.971 1181.24 Q181.8 1177.67 181.8 1170.57 Q181.8 1163.44 179.971 1159.89 Q178.166 1156.33 174.531 1156.33 M174.531 1152.63 Q180.342 1152.63 183.397 1157.23 Q186.476 1161.82 186.476 1170.57 Q186.476 1179.29 183.397 1183.9 Q180.342 1188.48 174.531 1188.48 Q168.721 1188.48 165.643 1183.9 Q162.587 1179.29 162.587 1170.57 Q162.587 1161.82 165.643 1157.23 Q168.721 1152.63 174.531 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M194.693 1181.93 L199.578 1181.93 L199.578 1187.81 L194.693 1187.81 L194.693 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M213.79 1183.88 L230.11 1183.88 L230.11 1187.81 L208.165 1187.81 L208.165 1183.88 Q210.827 1181.12 215.411 1176.49 Q220.017 1171.84 221.198 1170.5 Q223.443 1167.97 224.323 1166.24 Q225.226 1164.48 225.226 1162.79 Q225.226 1160.03 223.281 1158.3 Q221.36 1156.56 218.258 1156.56 Q216.059 1156.56 213.605 1157.32 Q211.175 1158.09 208.397 1159.64 L208.397 1154.92 Q211.221 1153.78 213.675 1153.2 Q216.128 1152.63 218.165 1152.63 Q223.536 1152.63 226.73 1155.31 Q229.925 1158 229.925 1162.49 Q229.925 1164.62 229.114 1166.54 Q228.327 1168.44 226.221 1171.03 Q225.642 1171.7 222.54 1174.92 Q219.439 1178.11 213.79 1183.88 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M660.704 1156.33 Q657.093 1156.33 655.264 1159.89 Q653.459 1163.44 653.459 1170.57 Q653.459 1177.67 655.264 1181.24 Q657.093 1184.78 660.704 1184.78 Q664.338 1184.78 666.144 1181.24 Q667.972 1177.67 667.972 1170.57 Q667.972 1163.44 666.144 1159.89 Q664.338 1156.33 660.704 1156.33 M660.704 1152.63 Q666.514 1152.63 669.57 1157.23 Q672.648 1161.82 672.648 1170.57 Q672.648 1179.29 669.57 1183.9 Q666.514 1188.48 660.704 1188.48 Q654.894 1188.48 651.815 1183.9 Q648.76 1179.29 648.76 1170.57 Q648.76 1161.82 651.815 1157.23 Q654.894 1152.63 660.704 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M680.866 1181.93 L685.75 1181.93 L685.75 1187.81 L680.866 1187.81 L680.866 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M708.782 1157.32 L696.977 1175.77 L708.782 1175.77 L708.782 1157.32 M707.556 1153.25 L713.435 1153.25 L713.435 1175.77 L718.366 1175.77 L718.366 1179.66 L713.435 1179.66 L713.435 1187.81 L708.782 1187.81 L708.782 1179.66 L693.181 1179.66 L693.181 1175.15 L707.556 1153.25 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1148.08 1156.33 Q1144.47 1156.33 1142.64 1159.89 Q1140.83 1163.44 1140.83 1170.57 Q1140.83 1177.67 1142.64 1181.24 Q1144.47 1184.78 1148.08 1184.78 Q1151.71 1184.78 1153.52 1181.24 Q1155.35 1177.67 1155.35 1170.57 Q1155.35 1163.44 1153.52 1159.89 Q1151.71 1156.33 1148.08 1156.33 M1148.08 1152.63 Q1153.89 1152.63 1156.95 1157.23 Q1160.02 1161.82 1160.02 1170.57 Q1160.02 1179.29 1156.95 1183.9 Q1153.89 1188.48 1148.08 1188.48 Q1142.27 1188.48 1139.19 1183.9 Q1136.14 1179.29 1136.14 1170.57 Q1136.14 1161.82 1139.19 1157.23 Q1142.27 1152.63 1148.08 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1168.24 1181.93 L1173.13 1181.93 L1173.13 1187.81 L1168.24 1187.81 L1168.24 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1193.89 1168.67 Q1190.74 1168.67 1188.89 1170.82 Q1187.06 1172.97 1187.06 1176.72 Q1187.06 1180.45 1188.89 1182.63 Q1190.74 1184.78 1193.89 1184.78 Q1197.04 1184.78 1198.87 1182.63 Q1200.72 1180.45 1200.72 1176.72 Q1200.72 1172.97 1198.87 1170.82 Q1197.04 1168.67 1193.89 1168.67 M1203.17 1154.01 L1203.17 1158.27 Q1201.41 1157.44 1199.61 1157 Q1197.83 1156.56 1196.07 1156.56 Q1191.44 1156.56 1188.98 1159.69 Q1186.55 1162.81 1186.21 1169.13 Q1187.57 1167.12 1189.63 1166.05 Q1191.69 1164.96 1194.17 1164.96 Q1199.38 1164.96 1202.39 1168.13 Q1205.42 1171.28 1205.42 1176.72 Q1205.42 1182.05 1202.27 1185.26 Q1199.12 1188.48 1193.89 1188.48 Q1187.89 1188.48 1184.72 1183.9 Q1181.55 1179.29 1181.55 1170.57 Q1181.55 1162.37 1185.44 1157.51 Q1189.33 1152.63 1195.88 1152.63 Q1197.64 1152.63 1199.42 1152.97 Q1201.23 1153.32 1203.17 1154.01 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1635.42 1156.33 Q1631.81 1156.33 1629.98 1159.89 Q1628.18 1163.44 1628.18 1170.57 Q1628.18 1177.67 1629.98 1181.24 Q1631.81 1184.78 1635.42 1184.78 Q1639.06 1184.78 1640.86 1181.24 Q1642.69 1177.67 1642.69 1170.57 Q1642.69 1163.44 1640.86 1159.89 Q1639.06 1156.33 1635.42 1156.33 M1635.42 1152.63 Q1641.23 1152.63 1644.29 1157.23 Q1647.37 1161.82 1647.37 1170.57 Q1647.37 1179.29 1644.29 1183.9 Q1641.23 1188.48 1635.42 1188.48 Q1629.61 1188.48 1626.53 1183.9 Q1623.48 1179.29 1623.48 1170.57 Q1623.48 1161.82 1626.53 1157.23 Q1629.61 1152.63 1635.42 1152.63 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1655.58 1181.93 L1660.47 1181.93 L1660.47 1187.81 L1655.58 1187.81 L1655.58 1181.93 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1680.65 1171.4 Q1677.32 1171.4 1675.4 1173.18 Q1673.5 1174.96 1673.5 1178.09 Q1673.5 1181.21 1675.4 1183 Q1677.32 1184.78 1680.65 1184.78 Q1683.99 1184.78 1685.91 1183 Q1687.83 1181.19 1687.83 1178.09 Q1687.83 1174.96 1685.91 1173.18 Q1684.01 1171.4 1680.65 1171.4 M1675.98 1169.41 Q1672.97 1168.67 1671.28 1166.61 Q1669.61 1164.55 1669.61 1161.58 Q1669.61 1157.44 1672.55 1155.03 Q1675.51 1152.63 1680.65 1152.63 Q1685.82 1152.63 1688.75 1155.03 Q1691.69 1157.44 1691.69 1161.58 Q1691.69 1164.55 1690 1166.61 Q1688.34 1168.67 1685.35 1169.41 Q1688.73 1170.2 1690.61 1172.49 Q1692.5 1174.78 1692.5 1178.09 Q1692.5 1183.11 1689.43 1185.8 Q1686.37 1188.48 1680.65 1188.48 Q1674.94 1188.48 1671.86 1185.8 Q1668.8 1183.11 1668.8 1178.09 Q1668.8 1174.78 1670.7 1172.49 Q1672.6 1170.2 1675.98 1169.41 M1674.26 1162.02 Q1674.26 1164.71 1675.93 1166.21 Q1677.62 1167.72 1680.65 1167.72 Q1683.66 1167.72 1685.35 1166.21 Q1687.07 1164.71 1687.07 1162.02 Q1687.07 1159.34 1685.35 1157.83 Q1683.66 1156.33 1680.65 1156.33 Q1677.62 1156.33 1675.93 1157.83 Q1674.26 1159.34 1674.26 1162.02 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,1128.61 145.191,47.2441 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,1052.94 164.089,1052.94 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,835.407 164.089,835.407 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,617.88 164.089,617.88 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,400.352 164.089,400.352 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="145.191,182.824 164.089,182.824 "></polyline>
<path clip-path="url(#clip520)" d="M52.9921 1053.39 L82.6679 1053.39 L82.6679 1057.32 L52.9921 1057.32 L52.9921 1053.39 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M105.608 1039.73 L93.8021 1058.18 L105.608 1058.18 L105.608 1039.73 M104.381 1035.66 L110.26 1035.66 L110.26 1058.18 L115.191 1058.18 L115.191 1062.07 L110.26 1062.07 L110.26 1070.22 L105.608 1070.22 L105.608 1062.07 L90.0058 1062.07 L90.0058 1057.55 L104.381 1035.66 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M55.0754 835.859 L84.7512 835.859 L84.7512 839.794 L55.0754 839.794 L55.0754 835.859 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M98.8715 848.752 L115.191 848.752 L115.191 852.687 L93.2465 852.687 L93.2465 848.752 Q95.9086 845.998 100.492 841.368 Q105.098 836.715 106.279 835.373 Q108.524 832.85 109.404 831.113 Q110.307 829.354 110.307 827.664 Q110.307 824.91 108.362 823.174 Q106.441 821.438 103.339 821.438 Q101.14 821.438 98.6863 822.201 Q96.2558 822.965 93.478 824.516 L93.478 819.794 Q96.3021 818.66 98.7558 818.081 Q101.209 817.502 103.246 817.502 Q108.617 817.502 111.811 820.188 Q115.006 822.873 115.006 827.363 Q115.006 829.493 114.196 831.414 Q113.408 833.312 111.302 835.905 Q110.723 836.576 107.621 839.794 Q104.52 842.988 98.8715 848.752 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M103.246 603.678 Q99.6354 603.678 97.8067 607.243 Q96.0012 610.785 96.0012 617.914 Q96.0012 625.021 97.8067 628.586 Q99.6354 632.127 103.246 632.127 Q106.881 632.127 108.686 628.586 Q110.515 625.021 110.515 617.914 Q110.515 610.785 108.686 607.243 Q106.881 603.678 103.246 603.678 M103.246 599.975 Q109.057 599.975 112.112 604.581 Q115.191 609.164 115.191 617.914 Q115.191 626.641 112.112 631.248 Q109.057 635.831 103.246 635.831 Q97.4363 635.831 94.3576 631.248 Q91.3021 626.641 91.3021 617.914 Q91.3021 609.164 94.3576 604.581 Q97.4363 599.975 103.246 599.975 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M98.8715 413.697 L115.191 413.697 L115.191 417.632 L93.2465 417.632 L93.2465 413.697 Q95.9086 410.942 100.492 406.313 Q105.098 401.66 106.279 400.317 Q108.524 397.794 109.404 396.058 Q110.307 394.299 110.307 392.609 Q110.307 389.854 108.362 388.118 Q106.441 386.382 103.339 386.382 Q101.14 386.382 98.6863 387.146 Q96.2558 387.91 93.478 389.461 L93.478 384.739 Q96.3021 383.604 98.7558 383.026 Q101.209 382.447 103.246 382.447 Q108.617 382.447 111.811 385.132 Q115.006 387.817 115.006 392.308 Q115.006 394.438 114.196 396.359 Q113.408 398.257 111.302 400.85 Q110.723 401.521 107.621 404.739 Q104.52 407.933 98.8715 413.697 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M105.608 169.618 L93.8021 188.067 L105.608 188.067 L105.608 169.618 M104.381 165.544 L110.26 165.544 L110.26 188.067 L115.191 188.067 L115.191 191.956 L110.26 191.956 L110.26 200.104 L105.608 200.104 L105.608 191.956 L90.0058 191.956 L90.0058 187.442 L104.381 165.544 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip521)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="196.348,77.8488 220.709,121.617 245.07,160.588 269.431,195.488 293.791,226.907 318.152,255.334 342.513,281.17 366.873,304.753 391.234,326.367 415.595,346.251 439.956,364.61 464.316,381.621 488.677,397.433 513.038,412.178 537.398,425.97 561.759,438.909 586.12,451.083 610.481,462.57 634.841,473.437 659.202,483.746 683.563,493.553 707.923,502.905 732.284,511.849 756.645,520.422 781.006,528.663 805.366,536.605 829.727,544.279 854.088,551.712 878.448,558.932 902.809,565.963 927.17,572.828 951.531,579.55 975.891,586.148 1000.25,592.644 1024.61,599.056 1048.97,605.404 1073.33,611.706 1097.69,617.98 1122.06,624.245 1146.42,630.52 1170.78,636.823 1195.14,643.175 1219.5,649.595 1243.86,656.104 1268.22,662.726 1292.58,669.484 1316.94,676.403 1341.3,683.512 1365.66,690.841 1390.02,698.424 1414.38,706.297 1438.74,714.503 1463.11,723.087 1487.47,732.104 1511.83,741.612 1536.19,751.681 1560.55,762.392 1584.91,773.837 1609.27,786.127 1633.63,799.393 1657.99,813.788 1682.35,829.502 1706.71,846.764 1731.07,865.855 1755.43,887.129 1779.79,911.031 1804.16,938.134 1828.52,969.187 1852.88,1005.19 1877.24,1047.49 1901.6,1098.01 "></polyline>
<polyline clip-path="url(#clip521)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" stroke-dasharray="16, 10" points="196.348,77.8488 220.709,121.617 245.07,160.588 269.431,195.488 293.791,226.907 318.152,255.334 342.513,281.17 366.873,304.753 391.234,326.367 415.595,346.251 439.956,364.61 464.316,381.621 488.677,397.433 513.038,412.178 537.398,425.97 561.759,438.909 586.12,451.083 610.481,462.57 634.841,473.437 659.202,483.746 683.563,493.553 707.923,502.905 732.284,511.849 756.645,520.422 781.006,528.663 805.366,536.605 829.727,544.279 854.088,551.712 878.448,558.932 902.809,565.963 927.17,572.828 951.531,579.55 975.891,586.148 1000.25,592.644 1024.61,599.056 1048.97,605.404 1073.33,611.706 1097.69,617.98 1122.06,624.245 1146.42,630.52 1170.78,636.823 1195.14,643.175 1219.5,649.595 1243.86,656.104 1268.22,662.726 1292.58,669.484 1316.94,676.403 1341.3,683.512 1365.66,690.841 1390.02,698.424 1414.38,706.297 1438.74,714.503 1463.11,723.087 1487.47,732.104 1511.83,741.612 1536.19,751.681 1560.55,762.392 1584.91,773.837 1609.27,786.127 1633.63,799.393 1657.99,813.788 1682.35,829.502 1706.71,846.764 1731.07,865.855 1755.43,887.129 1779.79,911.031 1804.16,938.134 1828.52,969.187 1852.88,1005.19 1877.24,1047.49 1901.6,1098.01 "></polyline>
<path clip-path="url(#clip520)" d="M1409.18 238.81 L1892.5 238.81 L1892.5 83.2896 L1409.18 83.2896  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip520)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1409.18,238.81 1892.5,238.81 1892.5,83.2896 1409.18,83.2896 1409.18,238.81 "></polyline>
<polyline clip-path="url(#clip520)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1429.26,135.13 1549.77,135.13 "></polyline>
<path clip-path="url(#clip520)" d="M1585.69 122.456 L1579.34 139.655 L1592.05 139.655 L1585.69 122.456 M1583.05 117.85 L1588.35 117.85 L1601.52 152.41 L1596.66 152.41 L1593.51 143.544 L1577.93 143.544 L1574.78 152.41 L1569.85 152.41 L1583.05 117.85 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1627.93 136.762 L1627.93 152.41 L1623.67 152.41 L1623.67 136.9 Q1623.67 133.22 1622.24 131.391 Q1620.8 129.563 1617.93 129.563 Q1614.48 129.563 1612.49 131.762 Q1610.5 133.961 1610.5 137.757 L1610.5 152.41 L1606.22 152.41 L1606.22 126.484 L1610.5 126.484 L1610.5 130.512 Q1612.03 128.174 1614.09 127.016 Q1616.17 125.859 1618.88 125.859 Q1623.35 125.859 1625.64 128.637 Q1627.93 131.391 1627.93 136.762 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1648.21 139.377 Q1643.05 139.377 1641.06 140.558 Q1639.06 141.738 1639.06 144.586 Q1639.06 146.854 1640.55 148.197 Q1642.05 149.516 1644.62 149.516 Q1648.16 149.516 1650.29 147.016 Q1652.44 144.493 1652.44 140.326 L1652.44 139.377 L1648.21 139.377 M1656.7 137.618 L1656.7 152.41 L1652.44 152.41 L1652.44 148.474 Q1650.99 150.836 1648.81 151.97 Q1646.63 153.081 1643.49 153.081 Q1639.5 153.081 1637.14 150.859 Q1634.81 148.613 1634.81 144.863 Q1634.81 140.488 1637.72 138.266 Q1640.66 136.044 1646.47 136.044 L1652.44 136.044 L1652.44 135.627 Q1652.44 132.688 1650.5 131.09 Q1648.58 129.47 1645.08 129.47 Q1642.86 129.47 1640.75 130.002 Q1638.65 130.535 1636.7 131.6 L1636.7 127.664 Q1639.04 126.762 1641.24 126.322 Q1643.44 125.859 1645.52 125.859 Q1651.15 125.859 1653.93 128.776 Q1656.7 131.692 1656.7 137.618 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1665.48 116.391 L1669.74 116.391 L1669.74 152.41 L1665.48 152.41 L1665.48 116.391 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1689.43 154.817 Q1687.63 159.447 1685.92 160.859 Q1684.2 162.271 1681.33 162.271 L1677.93 162.271 L1677.93 158.706 L1680.43 158.706 Q1682.19 158.706 1683.16 157.873 Q1684.13 157.039 1685.31 153.937 L1686.08 151.993 L1675.59 126.484 L1680.11 126.484 L1688.21 146.762 L1696.31 126.484 L1700.82 126.484 L1689.43 154.817 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1710.92 119.123 L1710.92 126.484 L1719.69 126.484 L1719.69 129.794 L1710.92 129.794 L1710.92 143.868 Q1710.92 147.039 1711.77 147.942 Q1712.65 148.845 1715.31 148.845 L1719.69 148.845 L1719.69 152.41 L1715.31 152.41 Q1710.38 152.41 1708.51 150.581 Q1706.63 148.729 1706.63 143.868 L1706.63 129.794 L1703.51 129.794 L1703.51 126.484 L1706.63 126.484 L1706.63 119.123 L1710.92 119.123 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1725.29 126.484 L1729.55 126.484 L1729.55 152.41 L1725.29 152.41 L1725.29 126.484 M1725.29 116.391 L1729.55 116.391 L1729.55 121.785 L1725.29 121.785 L1725.29 116.391 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1757.12 127.479 L1757.12 131.461 Q1755.31 130.465 1753.49 129.979 Q1751.68 129.47 1749.83 129.47 Q1745.68 129.47 1743.39 132.109 Q1741.1 134.725 1741.1 139.47 Q1741.1 144.215 1743.39 146.854 Q1745.68 149.47 1749.83 149.47 Q1751.68 149.47 1753.49 148.984 Q1755.31 148.474 1757.12 147.479 L1757.12 151.414 Q1755.34 152.248 1753.42 152.664 Q1751.52 153.081 1749.36 153.081 Q1743.51 153.081 1740.06 149.4 Q1736.61 145.72 1736.61 139.47 Q1736.61 133.127 1740.08 129.493 Q1743.58 125.859 1749.64 125.859 Q1751.61 125.859 1753.49 126.276 Q1755.36 126.669 1757.12 127.479 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1776.31 139.377 Q1771.15 139.377 1769.16 140.558 Q1767.17 141.738 1767.17 144.586 Q1767.17 146.854 1768.65 148.197 Q1770.15 149.516 1772.72 149.516 Q1776.26 149.516 1778.39 147.016 Q1780.55 144.493 1780.55 140.326 L1780.55 139.377 L1776.31 139.377 M1784.8 137.618 L1784.8 152.41 L1780.55 152.41 L1780.55 148.474 Q1779.09 150.836 1776.91 151.97 Q1774.74 153.081 1771.59 153.081 Q1767.61 153.081 1765.24 150.859 Q1762.91 148.613 1762.91 144.863 Q1762.91 140.488 1765.82 138.266 Q1768.76 136.044 1774.57 136.044 L1780.55 136.044 L1780.55 135.627 Q1780.55 132.688 1778.6 131.09 Q1776.68 129.47 1773.18 129.47 Q1770.96 129.47 1768.86 130.002 Q1766.75 130.535 1764.8 131.6 L1764.8 127.664 Q1767.14 126.762 1769.34 126.322 Q1771.54 125.859 1773.62 125.859 Q1779.25 125.859 1782.03 128.776 Q1784.8 131.692 1784.8 137.618 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1793.58 116.391 L1797.84 116.391 L1797.84 152.41 L1793.58 152.41 L1793.58 116.391 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip520)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" stroke-dasharray="16, 10" points="1429.26,186.97 1549.77,186.97 "></polyline>
<path clip-path="url(#clip520)" d="M1569.85 169.69 L1589.71 169.69 L1589.71 173.625 L1574.53 173.625 L1574.53 183.81 L1588.23 183.81 L1588.23 187.745 L1574.53 187.745 L1574.53 204.25 L1569.85 204.25 L1569.85 169.69 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1605.29 181.31 Q1601.87 181.31 1599.87 183.995 Q1597.88 186.657 1597.88 191.31 Q1597.88 195.963 1599.85 198.648 Q1601.84 201.31 1605.29 201.31 Q1608.69 201.31 1610.68 198.625 Q1612.68 195.94 1612.68 191.31 Q1612.68 186.703 1610.68 184.018 Q1608.69 181.31 1605.29 181.31 M1605.29 177.699 Q1610.85 177.699 1614.02 181.31 Q1617.19 184.921 1617.19 191.31 Q1617.19 197.676 1614.02 201.31 Q1610.85 204.921 1605.29 204.921 Q1599.71 204.921 1596.54 201.31 Q1593.39 197.676 1593.39 191.31 Q1593.39 184.921 1596.54 181.31 Q1599.71 177.699 1605.29 177.699 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1639.27 182.305 Q1638.56 181.889 1637.7 181.703 Q1636.87 181.495 1635.85 181.495 Q1632.24 181.495 1630.29 183.856 Q1628.37 186.194 1628.37 190.592 L1628.37 204.25 L1624.09 204.25 L1624.09 178.324 L1628.37 178.324 L1628.37 182.352 Q1629.71 179.991 1631.87 178.856 Q1634.02 177.699 1637.1 177.699 Q1637.54 177.699 1638.07 177.768 Q1638.6 177.815 1639.25 177.93 L1639.27 182.305 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1641.26 178.324 L1645.52 178.324 L1650.85 198.555 L1656.15 178.324 L1661.17 178.324 L1666.49 198.555 L1671.8 178.324 L1676.05 178.324 L1669.27 204.25 L1664.25 204.25 L1658.67 183 L1653.07 204.25 L1648.05 204.25 L1641.26 178.324 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1694.3 191.217 Q1689.13 191.217 1687.14 192.398 Q1685.15 193.578 1685.15 196.426 Q1685.15 198.694 1686.63 200.037 Q1688.14 201.356 1690.71 201.356 Q1694.25 201.356 1696.38 198.856 Q1698.53 196.333 1698.53 192.166 L1698.53 191.217 L1694.3 191.217 M1702.79 189.458 L1702.79 204.25 L1698.53 204.25 L1698.53 200.314 Q1697.07 202.676 1694.9 203.81 Q1692.72 204.921 1689.57 204.921 Q1685.59 204.921 1683.23 202.699 Q1680.89 200.453 1680.89 196.703 Q1680.89 192.328 1683.81 190.106 Q1686.75 187.884 1692.56 187.884 L1698.53 187.884 L1698.53 187.467 Q1698.53 184.528 1696.59 182.93 Q1694.67 181.31 1691.17 181.31 Q1688.95 181.31 1686.84 181.842 Q1684.74 182.375 1682.79 183.44 L1682.79 179.504 Q1685.13 178.602 1687.33 178.162 Q1689.53 177.699 1691.61 177.699 Q1697.24 177.699 1700.01 180.616 Q1702.79 183.532 1702.79 189.458 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1726.59 182.305 Q1725.87 181.889 1725.01 181.703 Q1724.18 181.495 1723.16 181.495 Q1719.55 181.495 1717.61 183.856 Q1715.68 186.194 1715.68 190.592 L1715.68 204.25 L1711.4 204.25 L1711.4 178.324 L1715.68 178.324 L1715.68 182.352 Q1717.03 179.991 1719.18 178.856 Q1721.33 177.699 1724.41 177.699 Q1724.85 177.699 1725.38 177.768 Q1725.92 177.815 1726.56 177.93 L1726.59 182.305 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1747.28 182.259 L1747.28 168.231 L1751.54 168.231 L1751.54 204.25 L1747.28 204.25 L1747.28 200.361 Q1745.94 202.676 1743.88 203.81 Q1741.84 204.921 1738.97 204.921 Q1734.27 204.921 1731.31 201.171 Q1728.37 197.421 1728.37 191.31 Q1728.37 185.199 1731.31 181.449 Q1734.27 177.699 1738.97 177.699 Q1741.84 177.699 1743.88 178.833 Q1745.94 179.944 1747.28 182.259 M1732.77 191.31 Q1732.77 196.009 1734.69 198.694 Q1736.63 201.356 1740.01 201.356 Q1743.39 201.356 1745.34 198.694 Q1747.28 196.009 1747.28 191.31 Q1747.28 186.611 1745.34 183.949 Q1743.39 181.264 1740.01 181.264 Q1736.63 181.264 1734.69 183.949 Q1732.77 186.611 1732.77 191.31 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1765.17 173.532 L1765.17 200.407 L1770.82 200.407 Q1777.98 200.407 1781.29 197.166 Q1784.62 193.926 1784.62 186.935 Q1784.62 179.991 1781.29 176.773 Q1777.98 173.532 1770.82 173.532 L1765.17 173.532 M1760.5 169.69 L1770.11 169.69 Q1780.15 169.69 1784.85 173.879 Q1789.55 178.046 1789.55 186.935 Q1789.55 195.87 1784.83 200.06 Q1780.11 204.25 1770.11 204.25 L1760.5 204.25 L1760.5 169.69 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1796.82 178.324 L1801.08 178.324 L1801.08 204.25 L1796.82 204.25 L1796.82 178.324 M1796.82 168.231 L1801.08 168.231 L1801.08 173.625 L1796.82 173.625 L1796.82 168.231 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1823.11 168.231 L1823.11 171.773 L1819.04 171.773 Q1816.75 171.773 1815.85 172.699 Q1814.97 173.625 1814.97 176.032 L1814.97 178.324 L1821.98 178.324 L1821.98 181.634 L1814.97 181.634 L1814.97 204.25 L1810.68 204.25 L1810.68 181.634 L1806.61 181.634 L1806.61 178.324 L1810.68 178.324 L1810.68 176.518 Q1810.68 172.19 1812.7 170.222 Q1814.71 168.231 1819.09 168.231 L1823.11 168.231 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1839.8 168.231 L1839.8 171.773 L1835.73 171.773 Q1833.44 171.773 1832.54 172.699 Q1831.66 173.625 1831.66 176.032 L1831.66 178.324 L1838.67 178.324 L1838.67 181.634 L1831.66 181.634 L1831.66 204.25 L1827.37 204.25 L1827.37 181.634 L1823.3 181.634 L1823.3 178.324 L1827.37 178.324 L1827.37 176.518 Q1827.37 172.19 1829.39 170.222 Q1831.4 168.231 1835.78 168.231 L1839.8 168.231 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1840.52 198.37 L1845.41 198.37 L1845.41 204.25 L1840.52 204.25 L1840.52 198.37 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1854.99 178.324 L1859.25 178.324 L1859.25 204.713 Q1859.25 209.666 1857.35 211.888 Q1855.48 214.111 1851.29 214.111 L1849.67 214.111 L1849.67 210.5 L1850.8 210.5 Q1853.23 210.5 1854.11 209.365 Q1854.99 208.254 1854.99 204.713 L1854.99 178.324 M1854.99 168.231 L1859.25 168.231 L1859.25 173.625 L1854.99 173.625 L1854.99 168.231 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip520)" d="M1868.16 168.231 L1872.42 168.231 L1872.42 204.25 L1868.16 204.25 L1868.16 168.231 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path></svg>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-comp-automatic-diff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Comparison of analytical and automatic derivatives.
</figcaption>
</figure>
</div>
</div>
</section>
</section>
<section id="並列計算" class="level2">
<h2 class="anchored" data-anchor-id="並列計算">並列計算</h2>
<p>現代のPCは複数のコアを持つマルチコアCPUを搭載しています. パッケージのバックグラウンドで並列計算が用いられていることもありますが, 基本的にはユーザーが明示的に並列計算を指示する必要があります.</p>
<p>まずは, 自分のPCが何コア持っているかを確認してみましょう.</p>
<div id="cell-check-cores" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Threads</span>.<span class="fu">nthreads</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="check-cores" class="cell-output cell-output-display" data-execution_count="1">
<pre><code>12</code></pre>
</div>
</div>
<p>ここで, スレッド数が1となっている場合は, Juliaを起動する前に環境変数 <code>JULIA_NUM_THREADS</code> を設定する必要があります.</p>
<ul>
<li>Quarto: <code>julia.exeflags: ["--threads=auto"]</code> をYAMLヘッダーに追加</li>
<li>VSCode: <code>settings.json</code> に <code>"julia.numThreads": "auto"</code> を追加</li>
<li>ターミナル: <code>export JULIA_NUM_THREADS=auto</code> を実行</li>
</ul>
<p><code>auto</code> と設定した場合, 利用可能なコア数に応じて自動的にスレッド数が設定されます. 現代のPCであれば, ほとんどの場合, 利用可能なコア数が2以上になるはずです.</p>
<div id="define-solve-multi" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_multi!</span>(m<span class="op">::</span><span class="dt">My.Model</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    (; T, n_a, r, w, β, a_grid) <span class="op">=</span> m</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="op">=</span> T<span class="op">:-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i_a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>            utility <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i_a′ <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                V′ <span class="op">=</span> (t <span class="op">==</span> T) ? <span class="fl">0.0</span> <span class="op">:</span> V[i_a′, t<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>                c <span class="op">=</span> (<span class="fl">1</span> <span class="op">+</span> r) <span class="op">*</span> a_grid[i_a] <span class="op">+</span> w <span class="op">-</span> a_grid[i_a′]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> c <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                    utility <span class="op">=</span> <span class="fu">max</span>(My.<span class="fu">u</span>(c, m) <span class="op">+</span> β <span class="op">*</span> V′, utility)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            V[i_a, t] <span class="op">=</span> utility</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    m.V <span class="op">.=</span> V</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-benchmark-single" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> My.<span class="fu">solve!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">1000</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="benchmark-single" class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 125 samples with 1 evaluation per sample.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">39.952 ms</span> … <span class="ansi-magenta-fg">40.570 ms</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">40.133 ms              </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">40.148 ms</span> ± <span class="ansi-green-fg">90.382 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.00% ± 0.00%

           ▂ ▂▄█▄▄ <span class="ansi-blue-fg"> </span> <span class="ansi-green-fg"> </span>▄▃▄ ▂                                    
  ▃▁▁▁▁▁▁▅▃████████<span class="ansi-blue-fg">█</span>█<span class="ansi-green-fg">█</span>███▆█▅▇▁▁▁▆▆▃▁▃▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▃▁▁▁▁▁▃ ▃
  40 ms<span class="ansi-bright-black-fg">           Histogram: frequency by time</span>        40.6 ms <span class="ansi-bold">&lt;</span>

 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">80.08 KiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">3</span>.</pre>
</div>
</div>
</div>
<div id="cell-benchmark-multi" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">solve_multi!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">1000</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="benchmark-multi" class="cell-output cell-output-display" data-execution_count="1">
<div class="ansi-escaped-output">
<pre>BenchmarkTools.Trial: 1204 samples with 1 evaluation per sample.
 Range <span class="ansi-bright-black-fg">(</span><span class="ansi-cyan-fg ansi-bold">min</span> … <span class="ansi-magenta-fg">max</span><span class="ansi-bright-black-fg">):  </span><span class="ansi-cyan-fg ansi-bold">3.887 ms</span> … <span class="ansi-magenta-fg"> 18.181 ms</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>min … max<span class="ansi-bright-black-fg">): </span>0.00% … 74.57%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-blue-fg ansi-bold">median</span><span class="ansi-bright-black-fg">):     </span><span class="ansi-blue-fg ansi-bold">3.987 ms               </span><span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>median<span class="ansi-bright-black-fg">):    </span>0.00%
 Time  <span class="ansi-bright-black-fg">(</span><span class="ansi-green-fg ansi-bold">mean</span> ± <span class="ansi-green-fg">σ</span><span class="ansi-bright-black-fg">):   </span><span class="ansi-green-fg ansi-bold">4.143 ms</span> ± <span class="ansi-green-fg">588.134 μs</span>  <span class="ansi-bright-black-fg">┊</span> GC <span class="ansi-bright-black-fg">(</span>mean ± σ<span class="ansi-bright-black-fg">):  </span>0.69% ±  3.79%

      ▅█<span class="ansi-blue-fg">▅</span>▂        <span class="ansi-green-fg">▁</span>▁       ▁▂▂▂▁▂▂                             
  ▅▁▄▆██<span class="ansi-blue-fg">█</span>███▇▇██▆▇<span class="ansi-green-fg">█</span>███▆▆▇███████████▆▆▅▇▅▆▅▅▄▆▅▅▄▄▄▁▄▅▁▅▄▁▄▁▄ █
  3.89 ms<span class="ansi-bright-black-fg">      </span><span class="ansi-bright-black-fg">Histogram: </span><span class="ansi-bright-black-fg ansi-bold">log(</span><span class="ansi-bright-black-fg">frequency</span><span class="ansi-bright-black-fg ansi-bold">)</span><span class="ansi-bright-black-fg"> by time</span>      4.85 ms <span class="ansi-bold">&lt;</span>

 Memory estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">181.02 KiB</span>, allocs estimate<span class="ansi-bright-black-fg">: </span><span class="ansi-yellow-fg">863</span>.</pre>
</div>
</div>
</div>
<p>並列化した場合, 1コアで実行した場合と比べて, おおむねスレッド数に応じて計算時間が短縮されていることがわかります. ただし, ここまで理論値に近い速度向上が得られることは稀で, 実際には理論値の数%から数十%程度の速度向上にとどまることが多いです.</p>
<p><strong>並列化できない計算</strong></p>
<p>並列計算の大前提は, 各スレッドが独立して計算できることです. 今回は後方帰納法で解くため, 時刻 <span class="math inline">\(t\)</span> の価値関数を計算する際に, 時刻 <span class="math inline">\(t+1\)</span> の価値関数が必要になり, 時刻方向に並列化することはできません.</p>
<div id="define-solve-muli-illegal" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_multi_illegal!</span>(m<span class="op">::</span><span class="dt">My.Model</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    (; T, n_a, r, w, β, a_grid) <span class="op">=</span> m</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> t <span class="op">=</span> T<span class="op">:-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i_a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>            utility <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i_a′ <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                V′ <span class="op">=</span> (t <span class="op">==</span> T) ? <span class="fl">0.0</span> <span class="op">:</span> V[i_a′, t<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                c <span class="op">=</span> (<span class="fl">1</span> <span class="op">+</span> r) <span class="op">*</span> a_grid[i_a] <span class="op">+</span> w <span class="op">-</span> a_grid[i_a′]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> c <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>                    utility <span class="op">=</span> <span class="fu">max</span>(My.<span class="fu">u</span>(c, m) <span class="op">+</span> β <span class="op">*</span> V′, utility)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>            V[i_a, t] <span class="op">=</span> utility</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    m.V <span class="op">.=</span> V</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-fig-vf-illegal" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">100</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">solve_multi_illegal!</span>(m)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m.a_grid, m.V[<span class="op">:</span>, <span class="kw">end</span>], xlabel<span class="op">=</span>L<span class="st">"a"</span>, ylabel<span class="op">=</span>L<span class="st">"V(a, t)"</span>, label<span class="op">=</span>L<span class="st">"t=T"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(m.a_grid, m.V[<span class="op">:</span>, <span class="kw">end</span><span class="op">-</span><span class="fl">2</span>], label<span class="op">=</span>L<span class="st">"t=T-2"</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(m.a_grid, m.V[<span class="op">:</span>, begin], label<span class="op">=</span>L<span class="st">"t=1"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="fig-vf-illegal" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="1">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-vf-illegal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<!--?xml version="1.0" encoding="utf-8"?-->
<svg xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" width="500" height="309" viewbox="0 0 2000 1236">
<defs>
  <clippath id="clip580">
    <rect x="0" y="0" width="2000" height="1236"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip580)" d="M0 1236 L2000 1236 L2000 1.24345e-14 L0 1.24345e-14  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip581">
    <rect x="145" y="47" width="1809" height="1082"></rect>
  </clippath>
</defs>
<path clip-path="url(#clip580)" d="M279.897 1068.81 L1952.76 1068.81 L1952.76 47.2441 L279.897 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<defs>
  <clippath id="clip582">
    <rect x="279" y="47" width="1674" height="1023"></rect>
  </clippath>
</defs>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="286.776,1068.81 286.776,47.2441 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="691.435,1068.81 691.435,47.2441 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1096.09,1068.81 1096.09,47.2441 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1500.75,1068.81 1500.75,47.2441 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1905.41,1068.81 1905.41,47.2441 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="279.897,937.069 1952.76,937.069 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="279.897,758.507 1952.76,758.507 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="279.897,579.944 1952.76,579.944 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="279.897,401.382 1952.76,401.382 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="279.897,222.819 1952.76,222.819 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="279.897,1068.81 1952.76,1068.81 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="286.776,1068.81 286.776,1049.91 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="691.435,1068.81 691.435,1049.91 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1096.09,1068.81 1096.09,1049.91 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1500.75,1068.81 1500.75,1049.91 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1905.41,1068.81 1905.41,1049.91 "></polyline>
<path clip-path="url(#clip580)" d="M286.776 1096.53 Q283.165 1096.53 281.336 1100.1 Q279.531 1103.64 279.531 1110.77 Q279.531 1117.87 281.336 1121.44 Q283.165 1124.98 286.776 1124.98 Q290.41 1124.98 292.216 1121.44 Q294.045 1117.87 294.045 1110.77 Q294.045 1103.64 292.216 1100.1 Q290.41 1096.53 286.776 1096.53 M286.776 1092.83 Q292.586 1092.83 295.642 1097.43 Q298.721 1102.02 298.721 1110.77 Q298.721 1119.49 295.642 1124.1 Q292.586 1128.68 286.776 1128.68 Q280.966 1128.68 277.887 1124.1 Q274.832 1119.49 274.832 1110.77 Q274.832 1102.02 277.887 1097.43 Q280.966 1092.83 286.776 1092.83 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M681.817 1124.08 L689.456 1124.08 L689.456 1097.71 L681.146 1099.38 L681.146 1095.12 L689.409 1093.45 L694.085 1093.45 L694.085 1124.08 L701.724 1124.08 L701.724 1128.01 L681.817 1128.01 L681.817 1124.08 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M1090.75 1124.08 L1107.07 1124.08 L1107.07 1128.01 L1085.12 1128.01 L1085.12 1124.08 Q1087.78 1121.32 1092.37 1116.69 Q1096.97 1112.04 1098.15 1110.7 Q1100.4 1108.17 1101.28 1106.44 Q1102.18 1104.68 1102.18 1102.99 Q1102.18 1100.23 1100.24 1098.5 Q1098.32 1096.76 1095.21 1096.76 Q1093.01 1096.76 1090.56 1097.53 Q1088.13 1098.29 1085.35 1099.84 L1085.35 1095.12 Q1088.18 1093.98 1090.63 1093.41 Q1093.08 1092.83 1095.12 1092.83 Q1100.49 1092.83 1103.69 1095.51 Q1106.88 1098.2 1106.88 1102.69 Q1106.88 1104.82 1106.07 1106.74 Q1105.28 1108.64 1103.18 1111.23 Q1102.6 1111.9 1099.5 1115.12 Q1096.39 1118.31 1090.75 1124.08 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M1505 1109.38 Q1508.36 1110.1 1510.23 1112.36 Q1512.13 1114.63 1512.13 1117.97 Q1512.13 1123.08 1508.61 1125.88 Q1505.09 1128.68 1498.61 1128.68 Q1496.44 1128.68 1494.12 1128.24 Q1491.83 1127.83 1489.37 1126.97 L1489.37 1122.46 Q1491.32 1123.59 1493.63 1124.17 Q1495.95 1124.75 1498.47 1124.75 Q1502.87 1124.75 1505.16 1123.01 Q1507.48 1121.28 1507.48 1117.97 Q1507.48 1114.91 1505.32 1113.2 Q1503.19 1111.46 1499.37 1111.46 L1495.35 1111.46 L1495.35 1107.62 L1499.56 1107.62 Q1503.01 1107.62 1504.84 1106.25 Q1506.67 1104.86 1506.67 1102.27 Q1506.67 1099.61 1504.77 1098.2 Q1502.89 1096.76 1499.37 1096.76 Q1497.45 1096.76 1495.25 1097.18 Q1493.06 1097.6 1490.42 1098.47 L1490.42 1094.31 Q1493.08 1093.57 1495.39 1093.2 Q1497.73 1092.83 1499.79 1092.83 Q1505.12 1092.83 1508.22 1095.26 Q1511.32 1097.66 1511.32 1101.78 Q1511.32 1104.66 1509.68 1106.65 Q1508.03 1108.61 1505 1109.38 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M1908.42 1097.53 L1896.61 1115.97 L1908.42 1115.97 L1908.42 1097.53 M1907.19 1093.45 L1913.07 1093.45 L1913.07 1115.97 L1918 1115.97 L1918 1119.86 L1913.07 1119.86 L1913.07 1128.01 L1908.42 1128.01 L1908.42 1119.86 L1892.82 1119.86 L1892.82 1115.35 L1907.19 1093.45 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M1129.26 1183.8 Q1128.39 1187.95 1127.27 1190.33 Q1125.46 1193.97 1122.4 1193.97 Q1120.08 1193.97 1118.44 1192.56 Q1116.8 1191.14 1116.41 1189.01 Q1112.19 1193.97 1107.81 1193.97 Q1103.95 1193.97 1101.5 1191.04 Q1099.05 1188.08 1099.05 1183.41 Q1099.05 1178.71 1101.37 1174.2 Q1103.72 1169.69 1107.43 1166.89 Q1111.13 1164.09 1114.93 1164.09 Q1118.96 1164.09 1121.02 1168.31 Q1121.18 1167.15 1121.92 1166.28 Q1122.66 1165.41 1123.79 1165.41 Q1124.66 1165.41 1125.17 1165.89 Q1125.69 1166.34 1125.69 1167.18 Q1125.69 1167.6 1125.24 1169.43 L1122.85 1178.64 L1121.4 1184.6 Q1120.86 1186.79 1120.7 1187.6 Q1120.57 1188.4 1120.57 1189.46 Q1120.57 1192.49 1122.53 1192.49 Q1123.5 1192.49 1124.27 1191.88 Q1125.04 1191.27 1125.66 1189.98 Q1126.27 1188.69 1126.65 1187.5 Q1127.04 1186.28 1127.56 1184.34 Q1127.72 1183.57 1127.85 1183.38 Q1128.01 1183.15 1128.46 1183.15 Q1129.26 1183.15 1129.26 1183.8 M1120.21 1171.33 Q1120.21 1171.04 1119.99 1170.24 Q1119.76 1169.43 1119.25 1168.31 Q1118.73 1167.18 1117.6 1166.37 Q1116.51 1165.54 1115.03 1165.54 Q1113.03 1165.54 1110.94 1167.24 Q1108.88 1168.95 1107.36 1171.85 Q1106.2 1174.17 1104.95 1179.03 Q1103.72 1183.89 1103.72 1186.31 Q1103.72 1187.79 1104.05 1189.11 Q1104.4 1190.4 1105.4 1191.46 Q1106.4 1192.49 1107.94 1192.49 Q1111.71 1192.49 1115.41 1187.82 Q1116.12 1187.02 1116.28 1186.69 Q1116.48 1186.34 1116.74 1185.37 L1120.02 1172.46 Q1120.21 1171.49 1120.21 1171.33 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="279.897,1068.81 279.897,47.2441 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="279.897,937.069 298.795,937.069 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="279.897,758.507 298.795,758.507 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="279.897,579.944 298.795,579.944 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="279.897,401.382 298.795,401.382 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="279.897,222.819 298.795,222.819 "></polyline>
<path clip-path="url(#clip580)" d="M113.787 937.521 L143.462 937.521 L143.462 941.456 L113.787 941.456 L113.787 937.521 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M163.555 922.868 Q159.944 922.868 158.115 926.433 Q156.309 929.975 156.309 937.104 Q156.309 944.211 158.115 947.775 Q159.944 951.317 163.555 951.317 Q167.189 951.317 168.995 947.775 Q170.823 944.211 170.823 937.104 Q170.823 929.975 168.995 926.433 Q167.189 922.868 163.555 922.868 M163.555 919.164 Q169.365 919.164 172.421 923.771 Q175.499 928.354 175.499 937.104 Q175.499 945.831 172.421 950.437 Q169.365 955.021 163.555 955.021 Q157.745 955.021 154.666 950.437 Q151.61 945.831 151.61 937.104 Q151.61 928.354 154.666 923.771 Q157.745 919.164 163.555 919.164 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M183.717 948.47 L188.601 948.47 L188.601 954.349 L183.717 954.349 L183.717 948.47 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M212.953 935.715 Q216.309 936.433 218.184 938.701 Q220.082 940.97 220.082 944.303 Q220.082 949.419 216.564 952.22 Q213.045 955.021 206.564 955.021 Q204.388 955.021 202.073 954.581 Q199.781 954.164 197.328 953.308 L197.328 948.794 Q199.272 949.928 201.587 950.507 Q203.902 951.086 206.425 951.086 Q210.823 951.086 213.115 949.349 Q215.43 947.613 215.43 944.303 Q215.43 941.248 213.277 939.535 Q211.147 937.799 207.328 937.799 L203.3 937.799 L203.3 933.956 L207.513 933.956 Q210.962 933.956 212.791 932.59 Q214.619 931.201 214.619 928.609 Q214.619 925.947 212.721 924.535 Q210.846 923.1 207.328 923.1 Q205.406 923.1 203.207 923.516 Q201.008 923.933 198.369 924.813 L198.369 920.646 Q201.031 919.905 203.346 919.535 Q205.684 919.164 207.744 919.164 Q213.068 919.164 216.17 921.595 Q219.272 924.002 219.272 928.123 Q219.272 930.993 217.629 932.984 Q215.985 934.951 212.953 935.715 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M228.994 919.789 L247.351 919.789 L247.351 923.725 L233.277 923.725 L233.277 932.197 Q234.295 931.85 235.314 931.687 Q236.332 931.502 237.351 931.502 Q243.138 931.502 246.517 934.674 Q249.897 937.845 249.897 943.261 Q249.897 948.84 246.425 951.942 Q242.953 955.021 236.633 955.021 Q234.457 955.021 232.189 954.65 Q229.943 954.28 227.536 953.539 L227.536 948.84 Q229.619 949.974 231.841 950.53 Q234.064 951.086 236.541 951.086 Q240.545 951.086 242.883 948.979 Q245.221 946.873 245.221 943.261 Q245.221 939.65 242.883 937.544 Q240.545 935.437 236.541 935.437 Q234.666 935.437 232.791 935.854 Q230.939 936.271 228.994 937.15 L228.994 919.789 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M112.791 758.958 L142.467 758.958 L142.467 762.893 L112.791 762.893 L112.791 758.958 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M162.559 744.305 Q158.948 744.305 157.12 747.87 Q155.314 751.412 155.314 758.541 Q155.314 765.648 157.12 769.213 Q158.948 772.754 162.559 772.754 Q166.194 772.754 167.999 769.213 Q169.828 765.648 169.828 758.541 Q169.828 751.412 167.999 747.87 Q166.194 744.305 162.559 744.305 M162.559 740.602 Q168.37 740.602 171.425 745.208 Q174.504 749.792 174.504 758.541 Q174.504 767.268 171.425 771.875 Q168.37 776.458 162.559 776.458 Q156.749 776.458 153.671 771.875 Q150.615 767.268 150.615 758.541 Q150.615 749.792 153.671 745.208 Q156.749 740.602 162.559 740.602 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M182.721 769.907 L187.606 769.907 L187.606 775.787 L182.721 775.787 L182.721 769.907 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M211.957 757.153 Q215.314 757.87 217.189 760.139 Q219.087 762.407 219.087 765.741 Q219.087 770.856 215.568 773.657 Q212.05 776.458 205.568 776.458 Q203.393 776.458 201.078 776.018 Q198.786 775.602 196.332 774.745 L196.332 770.231 Q198.277 771.365 200.592 771.944 Q202.906 772.523 205.43 772.523 Q209.828 772.523 212.119 770.787 Q214.434 769.051 214.434 765.741 Q214.434 762.685 212.281 760.972 Q210.152 759.236 206.332 759.236 L202.305 759.236 L202.305 755.393 L206.518 755.393 Q209.967 755.393 211.795 754.028 Q213.624 752.639 213.624 750.046 Q213.624 747.384 211.726 745.972 Q209.851 744.537 206.332 744.537 Q204.411 744.537 202.212 744.954 Q200.013 745.37 197.374 746.25 L197.374 742.083 Q200.036 741.343 202.351 740.972 Q204.689 740.602 206.749 740.602 Q212.073 740.602 215.175 743.032 Q218.277 745.44 218.277 749.56 Q218.277 752.43 216.633 754.421 Q214.99 756.389 211.957 757.153 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M237.953 744.305 Q234.341 744.305 232.513 747.87 Q230.707 751.412 230.707 758.541 Q230.707 765.648 232.513 769.213 Q234.341 772.754 237.953 772.754 Q241.587 772.754 243.392 769.213 Q245.221 765.648 245.221 758.541 Q245.221 751.412 243.392 747.87 Q241.587 744.305 237.953 744.305 M237.953 740.602 Q243.763 740.602 246.818 745.208 Q249.897 749.792 249.897 758.541 Q249.897 767.268 246.818 771.875 Q243.763 776.458 237.953 776.458 Q232.142 776.458 229.064 771.875 Q226.008 767.268 226.008 758.541 Q226.008 749.792 229.064 745.208 Q232.142 740.602 237.953 740.602 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M113.787 580.396 L143.462 580.396 L143.462 584.331 L113.787 584.331 L113.787 580.396 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M163.555 565.743 Q159.944 565.743 158.115 569.308 Q156.309 572.849 156.309 579.979 Q156.309 587.085 158.115 590.65 Q159.944 594.192 163.555 594.192 Q167.189 594.192 168.995 590.65 Q170.823 587.085 170.823 579.979 Q170.823 572.849 168.995 569.308 Q167.189 565.743 163.555 565.743 M163.555 562.039 Q169.365 562.039 172.421 566.646 Q175.499 571.229 175.499 579.979 Q175.499 588.706 172.421 593.312 Q169.365 597.895 163.555 597.895 Q157.745 597.895 154.666 593.312 Q151.61 588.706 151.61 579.979 Q151.61 571.229 154.666 566.646 Q157.745 562.039 163.555 562.039 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M183.717 591.345 L188.601 591.345 L188.601 597.224 L183.717 597.224 L183.717 591.345 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M202.814 593.289 L219.133 593.289 L219.133 597.224 L197.189 597.224 L197.189 593.289 Q199.851 590.534 204.434 585.905 Q209.041 581.252 210.221 579.909 Q212.467 577.386 213.346 575.65 Q214.249 573.891 214.249 572.201 Q214.249 569.447 212.305 567.71 Q210.383 565.974 207.281 565.974 Q205.082 565.974 202.629 566.738 Q200.198 567.502 197.42 569.053 L197.42 564.331 Q200.244 563.197 202.698 562.618 Q205.152 562.039 207.189 562.039 Q212.559 562.039 215.754 564.724 Q218.948 567.409 218.948 571.9 Q218.948 574.03 218.138 575.951 Q217.351 577.849 215.244 580.442 Q214.666 581.113 211.564 584.331 Q208.462 587.525 202.814 593.289 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M228.994 562.664 L247.351 562.664 L247.351 566.599 L233.277 566.599 L233.277 575.071 Q234.295 574.724 235.314 574.562 Q236.332 574.377 237.351 574.377 Q243.138 574.377 246.517 577.548 Q249.897 580.72 249.897 586.136 Q249.897 591.715 246.425 594.817 Q242.953 597.895 236.633 597.895 Q234.457 597.895 232.189 597.525 Q229.943 597.155 227.536 596.414 L227.536 591.715 Q229.619 592.849 231.841 593.405 Q234.064 593.96 236.541 593.96 Q240.545 593.96 242.883 591.854 Q245.221 589.747 245.221 586.136 Q245.221 582.525 242.883 580.419 Q240.545 578.312 236.541 578.312 Q234.666 578.312 232.791 578.729 Q230.939 579.146 228.994 580.025 L228.994 562.664 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M112.791 401.833 L142.467 401.833 L142.467 405.768 L112.791 405.768 L112.791 401.833 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M162.559 387.18 Q158.948 387.18 157.12 390.745 Q155.314 394.287 155.314 401.416 Q155.314 408.523 157.12 412.088 Q158.948 415.629 162.559 415.629 Q166.194 415.629 167.999 412.088 Q169.828 408.523 169.828 401.416 Q169.828 394.287 167.999 390.745 Q166.194 387.18 162.559 387.18 M162.559 383.477 Q168.37 383.477 171.425 388.083 Q174.504 392.666 174.504 401.416 Q174.504 410.143 171.425 414.75 Q168.37 419.333 162.559 419.333 Q156.749 419.333 153.671 414.75 Q150.615 410.143 150.615 401.416 Q150.615 392.666 153.671 388.083 Q156.749 383.477 162.559 383.477 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M182.721 412.782 L187.606 412.782 L187.606 418.662 L182.721 418.662 L182.721 412.782 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M201.818 414.726 L218.138 414.726 L218.138 418.662 L196.194 418.662 L196.194 414.726 Q198.856 411.972 203.439 407.342 Q208.045 402.689 209.226 401.347 Q211.471 398.824 212.351 397.088 Q213.254 395.328 213.254 393.639 Q213.254 390.884 211.309 389.148 Q209.388 387.412 206.286 387.412 Q204.087 387.412 201.633 388.176 Q199.203 388.939 196.425 390.49 L196.425 385.768 Q199.249 384.634 201.703 384.055 Q204.156 383.477 206.193 383.477 Q211.564 383.477 214.758 386.162 Q217.953 388.847 217.953 393.338 Q217.953 395.467 217.142 397.389 Q216.355 399.287 214.249 401.879 Q213.67 402.551 210.568 405.768 Q207.467 408.963 201.818 414.726 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M237.953 387.18 Q234.341 387.18 232.513 390.745 Q230.707 394.287 230.707 401.416 Q230.707 408.523 232.513 412.088 Q234.341 415.629 237.953 415.629 Q241.587 415.629 243.392 412.088 Q245.221 408.523 245.221 401.416 Q245.221 394.287 243.392 390.745 Q241.587 387.18 237.953 387.18 M237.953 383.477 Q243.763 383.477 246.818 388.083 Q249.897 392.666 249.897 401.416 Q249.897 410.143 246.818 414.75 Q243.763 419.333 237.953 419.333 Q232.142 419.333 229.064 414.75 Q226.008 410.143 226.008 401.416 Q226.008 392.666 229.064 388.083 Q232.142 383.477 237.953 383.477 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M113.787 223.27 L143.462 223.27 L143.462 227.205 L113.787 227.205 L113.787 223.27 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M163.555 208.618 Q159.944 208.618 158.115 212.182 Q156.309 215.724 156.309 222.854 Q156.309 229.96 158.115 233.525 Q159.944 237.067 163.555 237.067 Q167.189 237.067 168.995 233.525 Q170.823 229.96 170.823 222.854 Q170.823 215.724 168.995 212.182 Q167.189 208.618 163.555 208.618 M163.555 204.914 Q169.365 204.914 172.421 209.52 Q175.499 214.104 175.499 222.854 Q175.499 231.58 172.421 236.187 Q169.365 240.77 163.555 240.77 Q157.745 240.77 154.666 236.187 Q151.61 231.58 151.61 222.854 Q151.61 214.104 154.666 209.52 Q157.745 204.914 163.555 204.914 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M183.717 234.219 L188.601 234.219 L188.601 240.099 L183.717 240.099 L183.717 234.219 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M199.596 236.164 L207.235 236.164 L207.235 209.798 L198.925 211.465 L198.925 207.206 L207.189 205.539 L211.865 205.539 L211.865 236.164 L219.504 236.164 L219.504 240.099 L199.596 240.099 L199.596 236.164 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M228.994 205.539 L247.351 205.539 L247.351 209.474 L233.277 209.474 L233.277 217.946 Q234.295 217.599 235.314 217.437 Q236.332 217.252 237.351 217.252 Q243.138 217.252 246.517 220.423 Q249.897 223.594 249.897 229.011 Q249.897 234.59 246.425 237.692 Q242.953 240.77 236.633 240.77 Q234.457 240.77 232.189 240.4 Q229.943 240.029 227.536 239.289 L227.536 234.59 Q229.619 235.724 231.841 236.28 Q234.064 236.835 236.541 236.835 Q240.545 236.835 242.883 234.729 Q245.221 232.622 245.221 229.011 Q245.221 225.4 242.883 223.293 Q240.545 221.187 236.541 221.187 Q234.666 221.187 232.791 221.604 Q230.939 222.02 228.994 222.9 L228.994 205.539 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M26.363 606.478 Q27.5546 606.543 27.619 607.348 Q27.6834 608.572 27.8444 609.313 Q27.9733 610.053 28.4564 611.213 Q28.9394 612.372 30.0989 613.499 Q31.2583 614.627 33.094 615.786 L70.8715 639.522 Q71.58 639.94 71.8054 640.295 Q72.0631 640.617 72.0631 641.357 Q72.0631 642.034 71.7732 642.291 Q71.5156 642.549 70.5494 642.678 L29.8412 647.895 Q29.1005 647.992 28.7784 648.088 Q28.4564 648.185 28.1343 648.572 Q27.8122 648.926 27.7156 649.699 Q27.619 650.472 27.619 651.857 Q27.619 652.501 27.5868 652.791 Q27.5546 653.048 27.3936 653.274 Q27.2003 653.499 26.8139 653.499 Q26.2342 653.499 25.9443 653.274 Q25.6222 653.016 25.59 652.823 Q25.5578 652.597 25.5578 652.243 Q25.5578 651.696 25.6222 650.504 Q25.6867 649.312 25.6867 648.7 Q25.6867 648.121 25.7189 646.897 Q25.7511 645.673 25.7511 645.061 Q25.7511 643.708 25.6545 640.971 Q25.5578 638.201 25.5578 636.881 Q25.5578 635.979 26.2986 635.979 Q27.2003 635.979 27.4258 636.366 Q27.619 636.752 27.619 637.622 Q27.619 639.812 28.1665 641.003 Q28.714 642.163 29.5836 642.163 L64.4947 637.686 L32.2889 617.428 Q30.7752 616.43 29.7768 616.43 Q27.8444 616.43 27.619 619.49 Q27.619 620.52 26.8139 620.52 Q26.2342 620.52 25.9443 620.263 Q25.6222 620.005 25.59 619.812 Q25.5578 619.586 25.5578 619.264 Q25.5578 618.201 25.6545 616.044 Q25.7511 613.854 25.7511 612.759 Q25.7511 611.857 25.6545 610.021 Q25.5578 608.185 25.5578 607.348 Q25.5578 606.478 26.363 606.478 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M54.1244 597.758 Q42.9812 597.758 33.9958 593.603 Q30.2277 591.832 27.0715 589.352 Q23.9153 586.872 22.5305 585.23 Q21.1456 583.587 21.1456 583.136 Q21.1456 582.492 21.7897 582.46 Q22.1118 582.46 22.917 583.329 Q33.7381 593.957 54.1244 593.925 Q74.5752 593.925 84.9776 583.587 Q86.1049 582.46 86.4591 582.46 Q87.1032 582.46 87.1032 583.136 Q87.1032 583.587 85.7828 585.165 Q84.4624 586.743 81.435 589.191 Q78.4077 591.639 74.704 593.41 Q65.7185 597.758 54.1244 597.758 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M61.1775 546.182 Q65.3321 547.052 67.7153 548.179 Q71.3546 549.982 71.3546 553.042 Q71.3546 555.361 69.9375 557.003 Q68.5205 558.646 66.3949 559.032 Q71.3546 563.251 71.3546 567.631 Q71.3546 571.496 68.4238 573.944 Q65.4609 576.391 60.791 576.391 Q56.089 576.391 51.5802 574.072 Q47.0713 571.721 44.2694 568.018 Q41.4675 564.314 41.4675 560.514 Q41.4675 556.488 45.6865 554.427 Q44.5271 554.266 43.6575 553.525 Q42.788 552.784 42.788 551.657 Q42.788 550.788 43.2711 550.272 Q43.7219 549.757 44.5593 549.757 Q44.978 549.757 46.8137 550.208 L56.0246 552.591 L61.9827 554.04 Q64.1727 554.588 64.9778 554.749 Q65.783 554.878 66.8457 554.878 Q69.8731 554.878 69.8731 552.913 Q69.8731 551.947 69.2612 551.174 Q68.6493 550.401 67.361 549.789 Q66.0728 549.177 64.8812 548.791 Q63.6574 548.404 61.725 547.889 Q60.9521 547.728 60.7588 547.599 Q60.5334 547.438 60.5334 546.987 Q60.5334 546.182 61.1775 546.182 M48.7138 555.232 Q48.424 555.232 47.6188 555.457 Q46.8137 555.683 45.6865 556.198 Q44.5593 556.713 43.7541 557.841 Q42.9168 558.936 42.9168 560.417 Q42.9168 562.414 44.6237 564.507 Q46.3306 566.568 49.2291 568.082 Q51.548 569.242 56.411 570.498 Q61.2741 571.721 63.6896 571.721 Q65.171 571.721 66.4915 571.399 Q67.7797 571.045 68.8425 570.047 Q69.8731 569.048 69.8731 567.502 Q69.8731 563.734 65.2032 560.031 Q64.3981 559.322 64.076 559.161 Q63.7218 558.968 62.7556 558.71 L49.8411 555.425 Q48.8749 555.232 48.7138 555.232 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M69.551 540.913 Q68.4882 541.847 67.1034 541.847 Q65.7185 541.847 64.688 540.945 Q63.6252 540.011 63.6252 538.336 Q63.6252 536.372 65.5253 535.244 Q67.3932 534.117 70.5494 534.117 Q73.9632 534.117 77.1194 535.502 Q80.3078 536.887 81.8215 538.24 Q83.3351 539.592 83.3351 540.14 Q83.3351 540.784 82.6266 540.784 Q82.369 540.784 81.8859 540.333 Q76.7974 535.599 70.5494 535.566 Q69.551 535.566 69.551 535.695 L69.6799 535.856 Q70.6138 536.983 70.6138 538.336 Q70.6138 539.979 69.551 540.913 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M42.9168 493.046 Q43.8186 493.046 44.044 493.464 Q44.2372 493.883 44.2372 495.042 L44.2372 501.226 L63.6896 506.121 Q65.3965 506.508 66.8457 506.508 Q68.456 506.508 69.1646 506.025 Q69.8731 505.509 69.8731 504.447 Q69.8731 502.353 67.973 500.099 Q66.0728 497.812 61.4352 495.88 Q60.8233 495.622 60.6944 495.493 Q60.5334 495.332 60.5334 494.914 Q60.5334 494.108 61.1775 494.108 Q61.403 494.108 62.4335 494.559 Q63.4641 494.978 64.9778 495.912 Q66.4915 496.814 67.9085 498.005 Q69.3256 499.165 70.3562 500.936 Q71.3546 502.707 71.3546 504.608 Q71.3546 507.281 69.6477 508.988 Q67.9407 510.662 65.2677 510.662 Q64.3981 510.662 61.6284 509.986 Q58.8265 509.31 44.2372 505.638 L44.2372 511.467 Q44.2372 512.273 44.205 512.595 Q44.1728 512.884 44.0118 513.11 Q43.8186 513.303 43.4321 513.303 Q42.8202 513.303 42.5625 513.046 Q42.2727 512.788 42.2405 512.466 Q42.1761 512.112 42.1761 511.306 L42.1761 505.123 L31.7092 502.546 Q30.6786 502.289 30.0989 501.645 Q29.4869 500.968 29.4225 500.582 Q29.3259 500.195 29.3259 499.906 Q29.3259 499.036 29.809 498.521 Q30.2599 498.005 31.0972 498.005 Q31.5481 498.005 42.1761 500.711 L42.1761 494.914 Q42.1761 494.173 42.2083 493.883 Q42.2405 493.561 42.4015 493.303 Q42.5625 493.046 42.9168 493.046 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M86.4591 487.883 Q86.1371 487.883 85.3319 487.046 Q74.5107 476.418 54.1244 476.418 Q33.6737 476.418 23.3356 486.627 Q22.144 487.883 21.7897 487.883 Q21.1456 487.883 21.1456 487.239 Q21.1456 486.788 22.4661 485.21 Q23.7865 483.6 26.8139 481.184 Q29.8412 478.737 33.5449 476.933 Q42.5303 472.585 54.1244 472.585 Q65.2677 472.585 74.2531 476.74 Q78.0212 478.511 81.1774 480.991 Q84.3335 483.471 85.7184 485.113 Q87.1032 486.756 87.1032 487.239 Q87.1032 487.883 86.4591 487.883 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip582)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="327.242,400.383 343.183,394.429 359.124,388.573 375.065,382.813 391.006,377.147 406.948,371.573 422.889,366.088 438.83,360.69 454.771,355.378 470.712,350.148 486.653,345 502.594,339.931 518.535,334.94 534.476,330.024 550.417,325.183 566.358,320.414 582.3,315.715 598.241,311.086 614.182,306.524 630.123,302.029 646.064,297.598 662.005,293.231 677.946,288.926 693.887,284.682 709.828,280.497 725.769,276.37 741.711,272.3 757.652,268.286 773.593,264.327 789.534,260.422 805.475,256.568 821.416,252.767 837.357,249.016 853.298,245.314 869.239,241.66 885.18,238.054 901.122,234.495 917.063,230.982 933.004,227.513 948.945,224.088 964.886,220.706 980.827,217.367 996.768,214.069 1012.71,210.812 1028.65,207.595 1044.59,204.418 1060.53,201.278 1076.47,198.177 1092.41,195.113 1108.36,192.086 1124.3,189.094 1140.24,186.137 1156.18,183.216 1172.12,180.328 1188.06,177.473 1204,174.652 1219.94,171.863 1235.88,169.105 1251.83,166.379 1267.77,163.683 1283.71,161.018 1299.65,158.382 1315.59,155.775 1331.53,153.197 1347.47,150.647 1363.41,148.125 1379.35,145.631 1395.3,143.163 1411.24,140.721 1427.18,138.306 1443.12,135.916 1459.06,133.551 1475,131.211 1490.94,128.896 1506.88,126.604 1522.82,124.336 1538.77,122.092 1554.71,119.87 1570.65,117.671 1586.59,115.494 1602.53,113.34 1618.47,111.206 1634.41,109.094 1650.35,107.003 1666.29,104.932 1682.24,102.882 1698.18,100.852 1714.12,98.8416 1730.06,96.8506 1746,94.8788 1761.94,92.9259 1777.88,90.9915 1793.82,89.0756 1809.76,87.1777 1825.71,85.2976 1841.65,83.4352 1857.59,81.5901 1873.53,79.762 1889.47,77.9509 1905.41,76.1564 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="327.242,400.383 343.183,394.429 359.124,388.573 375.065,382.813 391.006,377.147 406.948,371.573 422.889,366.088 438.83,360.69 454.771,355.378 470.712,350.148 486.653,345 502.594,339.931 518.535,334.94 534.476,330.024 550.417,325.183 566.358,324.869 582.3,320.104 598.241,319.795 614.182,315.105 630.123,314.801 646.064,314.497 662.005,309.886 677.946,309.586 693.887,305.047 709.828,304.752 725.769,300.282 741.711,299.992 757.652,295.591 773.593,295.305 789.534,290.97 805.475,286.697 821.416,286.42 837.357,282.211 853.298,281.937 869.239,277.791 885.18,277.521 901.122,273.436 917.063,273.17 933.004,269.145 948.945,268.883 964.886,264.916 980.827,261.002 996.768,260.748 1012.71,256.891 1028.65,256.64 1044.59,252.837 1060.53,249.085 1076.47,248.841 1092.41,248.598 1108.36,244.902 1124.3,241.254 1140.24,241.017 1156.18,237.419 1172.12,237.185 1188.06,233.637 1204,233.407 1219.94,229.907 1235.88,226.452 1251.83,226.227 1267.77,222.819 1283.71,222.597 1299.65,219.234 1315.59,215.914 1331.53,215.698 1347.47,212.421 1363.41,212.208 1379.35,208.973 1395.3,205.779 1411.24,205.571 1427.18,202.418 1443.12,202.213 1459.06,199.101 1475,196.026 1490.94,195.826 1506.88,192.79 1522.82,192.592 1538.77,189.595 1554.71,186.632 1570.65,186.44 1586.59,183.514 1602.53,183.324 1618.47,180.435 1634.41,180.247 1650.35,177.394 1666.29,174.573 1682.24,174.39 1698.18,171.604 1714.12,171.422 1730.06,168.67 1746,168.491 1761.94,165.772 1777.88,163.083 1793.82,162.908 1809.76,160.251 1825.71,160.078 1841.65,157.453 1857.59,157.282 1873.53,154.687 1889.47,152.121 1905.41,151.954 "></polyline>
<polyline clip-path="url(#clip582)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="327.242,454.737 343.183,467.49 359.124,480.673 375.065,487.186 391.006,493.807 406.948,507.903 422.889,522.5 438.83,537.626 454.771,553.309 470.712,569.582 486.653,577.644 502.594,594.853 518.535,612.74 534.476,631.347 550.417,650.717 566.358,670.898 582.3,680.927 598.241,702.408 614.182,724.838 630.123,748.281 646.064,772.808 662.005,798.496 677.946,825.428 693.887,838.878 709.828,867.829 725.769,898.272 741.711,930.328 757.652,964.126 773.593,999.814 789.534,1037.55 805.475,1039.9 821.416,1036.1 837.357,1032.35 853.298,1028.64 869.239,1024.99 885.18,1021.39 901.122,1017.83 917.063,1014.31 933.004,1010.84 948.945,1007.42 964.886,1004.04 980.827,1000.7 996.768,997.4 1012.71,994.143 1028.65,990.926 1044.59,987.749 1060.53,984.609 1076.47,981.508 1092.41,978.444 1108.36,975.417 1124.3,972.425 1140.24,969.468 1156.18,966.547 1172.12,963.659 1188.06,960.804 1204,957.983 1219.94,955.194 1235.88,952.436 1251.83,949.71 1267.77,947.014 1283.71,944.349 1299.65,941.713 1315.59,939.106 1331.53,936.528 1347.47,933.978 1363.41,931.456 1379.35,928.961 1395.3,926.494 1411.24,924.052 1427.18,921.637 1443.12,919.247 1459.06,916.882 1475,914.542 1490.94,912.227 1506.88,909.935 1522.82,907.667 1538.77,905.423 1554.71,903.201 1570.65,901.002 1586.59,898.825 1602.53,896.67 1618.47,894.537 1634.41,892.425 1650.35,890.334 1666.29,888.263 1682.24,886.213 1698.18,884.183 1714.12,882.173 1730.06,880.182 1746,878.21 1761.94,876.257 1777.88,874.322 1793.82,872.407 1809.76,870.509 1825.71,868.629 1841.65,866.766 1857.59,864.921 1873.53,863.093 1889.47,861.282 1905.41,859.487 "></polyline>
<path clip-path="url(#clip580)" d="M335.659 1034.76 L698.752 1034.76 L698.752 827.399 L335.659 827.399  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"></path>
<polyline clip-path="url(#clip580)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="335.659,1034.76 698.752,1034.76 698.752,827.399 335.659,827.399 335.659,1034.76 "></polyline>
<polyline clip-path="url(#clip580)" style="stroke:#009af9; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="354.246,879.239 465.77,879.239 "></polyline>
<path clip-path="url(#clip580)" d="M499.09 874.903 Q499.09 875.559 498.786 875.723 Q498.481 875.864 497.638 875.864 L493.141 875.864 L489.581 890.011 Q489.3 891.252 489.3 892.306 Q489.3 893.477 489.651 893.993 Q490.026 894.508 490.799 894.508 Q492.321 894.508 493.961 893.126 Q495.624 891.744 497.029 888.371 Q497.216 887.926 497.31 887.833 Q497.427 887.715 497.732 887.715 Q498.317 887.715 498.317 888.184 Q498.317 888.348 497.989 889.097 Q497.685 889.847 497.006 890.948 Q496.35 892.049 495.483 893.079 Q494.64 894.11 493.352 894.859 Q492.063 895.585 490.682 895.585 Q488.737 895.585 487.496 894.344 Q486.278 893.103 486.278 891.159 Q486.278 890.526 486.77 888.512 Q487.262 886.474 489.932 875.864 L485.693 875.864 Q485.107 875.864 484.873 875.84 Q484.662 875.817 484.498 875.7 Q484.357 875.559 484.357 875.278 Q484.357 874.833 484.545 874.646 Q484.732 874.435 484.966 874.412 Q485.224 874.365 485.81 874.365 L490.307 874.365 L492.181 866.752 Q492.368 866.003 492.836 865.581 Q493.328 865.136 493.609 865.089 Q493.89 865.019 494.101 865.019 Q494.734 865.019 495.108 865.37 Q495.483 865.698 495.483 866.307 Q495.483 866.635 493.516 874.365 L497.732 874.365 Q498.27 874.365 498.481 874.388 Q498.715 874.412 498.903 874.529 Q499.09 874.646 499.09 874.903 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M514.813 887.762 Q514.86 887.177 515.774 887.177 L545.169 887.177 Q546.551 887.177 546.574 887.715 Q546.574 888.301 545.262 888.278 L516.102 888.278 Q514.813 888.301 514.813 887.762 M514.813 878.393 Q514.813 877.808 515.82 877.831 L545.122 877.831 Q546.551 877.831 546.574 878.393 Q546.574 878.932 545.356 878.932 L515.774 878.932 Q514.813 878.932 514.813 878.393 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M597.709 863.099 Q597.709 863.544 597.615 863.918 L596.304 872.257 Q596.234 872.889 596.093 873.123 Q595.976 873.358 595.601 873.358 Q595.016 873.358 595.016 872.749 Q595.016 872.397 595.156 871.835 Q595.554 869.188 595.554 867.994 Q595.554 867.197 595.39 866.612 Q595.25 866.003 595.016 865.581 Q594.805 865.16 594.313 864.879 Q593.821 864.598 593.353 864.434 Q592.884 864.27 592.041 864.199 Q591.198 864.106 590.472 864.082 Q589.745 864.059 588.551 864.059 Q585.951 864.059 585.529 864.153 Q585.084 864.27 584.85 864.621 Q584.639 864.949 584.405 865.933 L578.034 891.393 L577.847 892.4 Q577.847 892.962 578.198 893.15 Q578.55 893.337 579.627 893.454 Q581.173 893.571 582.695 893.571 Q582.742 893.571 582.836 893.571 Q583.351 893.571 583.562 893.595 Q583.773 893.595 583.984 893.641 Q584.194 893.688 584.241 893.805 Q584.311 893.899 584.311 894.086 Q584.311 894.531 584.124 894.766 Q583.937 894.976 583.749 895.023 Q583.585 895.047 583.257 895.047 Q582.602 895.047 581.196 895 Q579.791 894.953 579.088 894.953 L575.106 894.906 L571.031 894.953 Q570.399 894.953 569.063 895 Q567.728 895.047 567.096 895.047 Q566.276 895.047 566.276 894.461 Q566.276 893.805 566.581 893.688 Q566.909 893.571 568.291 893.571 Q570.235 893.571 571.289 893.477 Q572.343 893.384 572.905 893.056 Q573.49 892.728 573.654 892.4 Q573.818 892.049 574.006 891.252 L580.447 865.652 Q580.634 865.089 580.634 864.644 Q580.634 864.41 580.564 864.316 Q580.517 864.223 580.213 864.153 Q579.908 864.059 579.276 864.059 L577.402 864.059 Q575.481 864.059 574.287 864.153 Q573.116 864.223 571.991 864.574 Q570.89 864.925 570.235 865.417 Q569.602 865.909 568.9 866.916 Q568.197 867.924 567.682 869.141 Q567.19 870.359 566.487 872.35 Q566.253 873.006 566.112 873.194 Q565.995 873.358 565.667 873.358 Q565.433 873.358 565.246 873.217 Q565.082 873.053 565.082 872.842 Q565.316 872.069 565.363 871.976 L568.244 863.52 Q568.478 862.841 568.689 862.724 Q568.923 862.583 569.79 862.583 L596.397 862.583 Q596.819 862.583 596.96 862.583 Q597.1 862.583 597.334 862.63 Q597.569 862.677 597.639 862.794 Q597.709 862.911 597.709 863.099 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip580)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="354.246,931.079 465.77,931.079 "></polyline>
<path clip-path="url(#clip580)" d="M499.09 926.743 Q499.09 927.399 498.786 927.563 Q498.481 927.704 497.638 927.704 L493.141 927.704 L489.581 941.851 Q489.3 943.092 489.3 944.146 Q489.3 945.317 489.651 945.833 Q490.026 946.348 490.799 946.348 Q492.321 946.348 493.961 944.966 Q495.624 943.584 497.029 940.211 Q497.216 939.766 497.31 939.673 Q497.427 939.555 497.732 939.555 Q498.317 939.555 498.317 940.024 Q498.317 940.188 497.989 940.937 Q497.685 941.687 497.006 942.788 Q496.35 943.889 495.483 944.919 Q494.64 945.95 493.352 946.699 Q492.063 947.425 490.682 947.425 Q488.737 947.425 487.496 946.184 Q486.278 944.943 486.278 942.999 Q486.278 942.366 486.77 940.352 Q487.262 938.314 489.932 927.704 L485.693 927.704 Q485.107 927.704 484.873 927.68 Q484.662 927.657 484.498 927.54 Q484.357 927.399 484.357 927.118 Q484.357 926.673 484.545 926.486 Q484.732 926.275 484.966 926.252 Q485.224 926.205 485.81 926.205 L490.307 926.205 L492.181 918.592 Q492.368 917.843 492.836 917.421 Q493.328 916.976 493.609 916.929 Q493.89 916.859 494.101 916.859 Q494.734 916.859 495.108 917.21 Q495.483 917.538 495.483 918.147 Q495.483 918.475 493.516 926.205 L497.732 926.205 Q498.27 926.205 498.481 926.228 Q498.715 926.252 498.903 926.369 Q499.09 926.486 499.09 926.743 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M514.813 939.602 Q514.86 939.017 515.774 939.017 L545.169 939.017 Q546.551 939.017 546.574 939.555 Q546.574 940.141 545.262 940.118 L516.102 940.118 Q514.813 940.141 514.813 939.602 M514.813 930.233 Q514.813 929.648 515.82 929.671 L545.122 929.671 Q546.551 929.671 546.574 930.233 Q546.574 930.772 545.356 930.772 L515.774 930.772 Q514.813 930.772 514.813 930.233 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M597.709 914.939 Q597.709 915.384 597.615 915.758 L596.304 924.097 Q596.234 924.729 596.093 924.963 Q595.976 925.198 595.601 925.198 Q595.016 925.198 595.016 924.589 Q595.016 924.237 595.156 923.675 Q595.554 921.028 595.554 919.834 Q595.554 919.037 595.39 918.452 Q595.25 917.843 595.016 917.421 Q594.805 917 594.313 916.719 Q593.821 916.438 593.353 916.274 Q592.884 916.11 592.041 916.039 Q591.198 915.946 590.472 915.922 Q589.745 915.899 588.551 915.899 Q585.951 915.899 585.529 915.993 Q585.084 916.11 584.85 916.461 Q584.639 916.789 584.405 917.773 L578.034 943.233 L577.847 944.24 Q577.847 944.802 578.198 944.99 Q578.55 945.177 579.627 945.294 Q581.173 945.411 582.695 945.411 Q582.742 945.411 582.836 945.411 Q583.351 945.411 583.562 945.435 Q583.773 945.435 583.984 945.481 Q584.194 945.528 584.241 945.645 Q584.311 945.739 584.311 945.926 Q584.311 946.371 584.124 946.606 Q583.937 946.816 583.749 946.863 Q583.585 946.887 583.257 946.887 Q582.602 946.887 581.196 946.84 Q579.791 946.793 579.088 946.793 L575.106 946.746 L571.031 946.793 Q570.399 946.793 569.063 946.84 Q567.728 946.887 567.096 946.887 Q566.276 946.887 566.276 946.301 Q566.276 945.645 566.581 945.528 Q566.909 945.411 568.291 945.411 Q570.235 945.411 571.289 945.317 Q572.343 945.224 572.905 944.896 Q573.49 944.568 573.654 944.24 Q573.818 943.889 574.006 943.092 L580.447 917.492 Q580.634 916.929 580.634 916.484 Q580.634 916.25 580.564 916.156 Q580.517 916.063 580.213 915.993 Q579.908 915.899 579.276 915.899 L577.402 915.899 Q575.481 915.899 574.287 915.993 Q573.116 916.063 571.991 916.414 Q570.89 916.765 570.235 917.257 Q569.602 917.749 568.9 918.756 Q568.197 919.764 567.682 920.981 Q567.19 922.199 566.487 924.19 Q566.253 924.846 566.112 925.034 Q565.995 925.198 565.667 925.198 Q565.433 925.198 565.246 925.057 Q565.082 924.893 565.082 924.682 Q565.316 923.909 565.363 923.816 L568.244 915.36 Q568.478 914.681 568.689 914.564 Q568.923 914.423 569.79 914.423 L596.397 914.423 Q596.819 914.423 596.96 914.423 Q597.1 914.423 597.334 914.47 Q597.569 914.517 597.639 914.634 Q597.709 914.751 597.709 914.939 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M637.807 934.215 Q638.088 934.496 638.088 934.894 Q638.088 935.293 637.807 935.574 Q637.526 935.855 637.128 935.855 L607.1 935.855 Q606.702 935.855 606.421 935.574 Q606.14 935.293 606.14 934.894 Q606.14 934.496 606.421 934.215 Q606.702 933.934 607.1 933.934 L637.128 933.934 Q637.526 933.934 637.807 934.215 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M656.408 946.887 Q656.408 946.02 656.478 945.762 Q656.572 945.505 656.947 945.107 L666.152 934.848 Q671.188 929.179 671.188 924.237 Q671.188 921.028 669.501 918.733 Q667.838 916.438 664.77 916.438 Q662.662 916.438 660.882 917.726 Q659.102 919.014 658.282 921.309 Q658.422 921.263 658.914 921.263 Q660.109 921.263 660.765 922.012 Q661.444 922.762 661.444 923.769 Q661.444 925.057 660.601 925.689 Q659.781 926.298 658.961 926.298 Q658.633 926.298 658.188 926.228 Q657.767 926.158 657.087 925.502 Q656.408 924.823 656.408 923.628 Q656.408 920.279 658.938 917.609 Q661.491 914.939 665.379 914.939 Q669.782 914.939 672.663 917.562 Q675.568 920.162 675.568 924.237 Q675.568 925.666 675.123 926.978 Q674.701 928.266 674.115 929.273 Q673.553 930.28 672.007 931.896 Q670.462 933.513 669.22 934.66 Q667.979 935.808 665.192 938.244 L660.109 943.186 L668.752 943.186 Q672.968 943.186 673.296 942.811 Q673.764 942.132 674.35 938.548 L675.568 938.548 L674.209 946.887 L656.408 946.887 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><polyline clip-path="url(#clip580)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="354.246,982.919 465.77,982.919 "></polyline>
<path clip-path="url(#clip580)" d="M499.09 978.33 Q499.09 978.985 498.786 979.149 Q498.481 979.29 497.638 979.29 L493.141 979.29 L489.581 993.437 Q489.3 994.678 489.3 995.732 Q489.3 996.904 489.651 997.419 Q490.026 997.934 490.799 997.934 Q492.321 997.934 493.961 996.552 Q495.624 995.17 497.029 991.797 Q497.216 991.352 497.31 991.259 Q497.427 991.142 497.732 991.142 Q498.317 991.142 498.317 991.61 Q498.317 991.774 497.989 992.524 Q497.685 993.273 497.006 994.374 Q496.35 995.475 495.483 996.505 Q494.64 997.536 493.352 998.285 Q492.063 999.012 490.682 999.012 Q488.737 999.012 487.496 997.77 Q486.278 996.529 486.278 994.585 Q486.278 993.952 486.77 991.938 Q487.262 989.9 489.932 979.29 L485.693 979.29 Q485.107 979.29 484.873 979.266 Q484.662 979.243 484.498 979.126 Q484.357 978.985 484.357 978.704 Q484.357 978.259 484.545 978.072 Q484.732 977.861 484.966 977.838 Q485.224 977.791 485.81 977.791 L490.307 977.791 L492.181 970.179 Q492.368 969.429 492.836 969.007 Q493.328 968.562 493.609 968.516 Q493.89 968.445 494.101 968.445 Q494.734 968.445 495.108 968.797 Q495.483 969.124 495.483 969.733 Q495.483 970.061 493.516 977.791 L497.732 977.791 Q498.27 977.791 498.481 977.814 Q498.715 977.838 498.903 977.955 Q499.09 978.072 499.09 978.33 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M514.813 991.188 Q514.86 990.603 515.774 990.603 L545.169 990.603 Q546.551 990.603 546.574 991.142 Q546.574 991.727 545.262 991.704 L516.102 991.704 Q514.813 991.727 514.813 991.188 M514.813 981.819 Q514.813 981.234 515.82 981.257 L545.122 981.257 Q546.551 981.257 546.574 981.819 Q546.574 982.358 545.356 982.358 L515.774 982.358 Q514.813 982.358 514.813 981.819 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path><path clip-path="url(#clip580)" d="M565.082 971.092 L565.082 969.593 Q570.844 969.593 573.818 966.525 Q574.638 966.525 574.779 966.712 Q574.919 966.899 574.919 967.766 L574.919 994.678 Q574.919 996.107 575.622 996.552 Q576.324 996.997 579.393 996.997 L580.915 996.997 L580.915 998.473 Q579.229 998.332 573.139 998.332 Q567.049 998.332 565.386 998.473 L565.386 996.997 L566.909 996.997 Q569.93 996.997 570.656 996.576 Q571.382 996.131 571.382 994.678 L571.382 969.827 Q568.876 971.092 565.082 971.092 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1"></path></svg>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-vf-illegal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Value function computed with illegal parallelization.
</figcaption>
</figure>
</div>
</div>
<p><a href="#fig-vf-illegal" class="quarto-xref">図&nbsp;4</a> のように, 時間方向に並列化すると正しい価値関数が得られません.</p>
</section>
<section id="monte-carlo-simulation-for-smm" class="level2">
<h2 class="anchored" data-anchor-id="monte-carlo-simulation-for-smm">Monte Carlo Simulation for SMM</h2>
<p>SMM (Simulated Method of Moments) のようなシミュレーションベースの推定では, モデルのパラメータを変化させながら (モンテカルロ) シミュレーションを繰り返す必要があります. このとき, 正確に実装しないと, モデルのパラメータを変化させるたびにランダムな数を生成してまい, 正確な最適化ができません. そのため, モデルのパラメータを変化させるたびに新たに乱数を生成するのではなく, 事前に乱数を生成しておきそれを使いまわす必要があります.</p>
<p>例として, 第二回の授業で扱った次のモデルを考えましょう.</p>
<p><strong>モデル</strong></p>
<p><span class="math display">\[
\max_{c, l} u(c, l) = \frac{c^{1-\gamma_c}}{1-\gamma_c} + \alpha_l \frac{l^{1-\gamma_l}}{1-\gamma_l} \quad \text{s.t.} \quad c = w (1 - l),
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\log w \sim \mathcal{N}(\mu, \sigma).
\]</span></p>
<p>標準化のため, <span class="math inline">\(\mu = 0\)</span> とする. この時, <span class="math inline">\(\theta = (\alpha, \sigma)\)</span> を推定する.</p>
<div id="prep-dist-earn" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mean_hours_data <span class="op">=</span> <span class="fl">33.4</span> <span class="op">/</span> (<span class="fl">16</span> <span class="op">*</span> <span class="fl">7</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>earn <span class="op">=</span> [<span class="fl">25</span>, <span class="fl">75</span>, <span class="fl">150</span>, <span class="fl">250</span>, <span class="fl">350</span>, <span class="fl">450</span>, <span class="fl">550</span>, <span class="fl">650</span>, <span class="fl">750</span>, <span class="fl">850</span>, <span class="fl">950</span>, <span class="fl">1100</span>, <span class="fl">1200</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>density <span class="op">=</span> [<span class="fl">13.7</span>, <span class="fl">12.2</span>, <span class="fl">12.3</span>, <span class="fl">14.8</span>, <span class="fl">20.2</span>, <span class="fl">16.3</span>, <span class="fl">7.0</span>, <span class="fl">2.0</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>] <span class="op">/</span> <span class="fl">100</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>mean_learn_data <span class="op">=</span> density<span class="op">'</span> <span class="op">*</span> <span class="fu">log</span>.(earn)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>sd_learn_data <span class="op">=</span> <span class="fu">sqrt</span>(density<span class="op">'</span> <span class="op">*</span> (<span class="fu">log</span>.(earn) <span class="op">.-</span> mean_learn_data) <span class="op">.^</span> <span class="fl">2</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">foc</span>(l; w<span class="op">=</span><span class="fl">1.0</span>, γ_c<span class="op">=</span><span class="fl">1.5</span>, α_l<span class="op">=</span><span class="fl">1.2</span>, γ_l<span class="op">=</span><span class="fl">1.5</span>) <span class="op">=</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    w<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> γ_c) <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> l)<span class="op">^</span>(<span class="op">-</span>γ_c) <span class="op">-</span> α_l <span class="op">*</span> l<span class="op">^</span>(<span class="op">-</span>γ_l)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">hours_worked</span>(w; γ_c<span class="op">=</span><span class="fl">1.5</span>, γ_l<span class="op">=</span><span class="fl">1.5</span>, α<span class="op">=</span><span class="fl">1.2</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    y<span class="op">::</span><span class="dt">Float64 </span><span class="op">=</span> <span class="fu">find_zero</span>(y <span class="op">-&gt;</span> <span class="fu">foc</span>(<span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu">exp</span>(y)), w<span class="op">=</span>w, γ_c<span class="op">=</span>γ_c, α_l<span class="op">=</span>α, γ_l<span class="op">=</span>γ_l), <span class="fl">0.0</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    l <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu">exp</span>(y))</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1</span> <span class="op">-</span> l</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><strong>悪い実装例</strong></p>
<div id="smm-mc-naive" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mc_bad</span>(α, σ; n_mc<span class="op">=</span><span class="fl">10</span><span class="op">^</span><span class="fl">3</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">=</span> <span class="fu">rand</span>(<span class="fu">LogNormal</span>(<span class="fl">0</span>, σ), n_mc)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    hs <span class="op">=</span> <span class="fu">similar</span>(ws)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    learns <span class="op">=</span> <span class="fu">similar</span>(hs)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, w) <span class="kw">in</span> <span class="fu">enumerate</span>(ws)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="fu">hours_worked</span>(w; α<span class="op">=</span>α)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        hs[i] <span class="op">=</span> h</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        learns[i] <span class="op">=</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> h))</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="fu">mean</span>(hs), <span class="fu">std</span>(hs)]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">loss</span>(α, σ; fn_mc, d<span class="op">=</span>[mean_hours_data, sd_learn_data]) <span class="op">=</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">sum</span>(((<span class="fu">fn_mc</span>(α, σ) <span class="op">.-</span> d) <span class="op">./</span> d) <span class="op">.^</span> <span class="fl">2</span>))</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>prob <span class="op">=</span> <span class="fu">OptimizationProblem</span>((x, p) <span class="op">-&gt;</span> <span class="fu">loss</span>(x[<span class="fl">1</span>], x[<span class="fl">2</span>], fn_mc<span class="op">=</span>mc_bad), [<span class="fl">0.5</span>, <span class="fl">0.5</span>],</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    lb<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">1e-3</span>], ub<span class="op">=</span>[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    sol <span class="op">=</span> <span class="fu">solve</span>(prob, NLopt.<span class="fu">LN_SBPLX</span>())</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="cf">catch</span> <span class="cn">e</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Optimization failed as expected:"</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="cn">e</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimization failed as expected:
CapturedException(Roots.ConvergenceFailed("Algorithm failed to converge"), Any[(#find_zero#40 at find_zero.jl:229 [inlined], 1), (find_zero at find_zero.jl:210 [inlined], 2), (find_zero at find_zero.jl:243 [inlined], 1), (#hours_worked#9 at 10-2-numerical-method.qmd:429 [inlined], 1), (hours_worked at 10-2-numerical-method.qmd:428 [inlined], 1), (mc_bad(α::Float64, σ::Float64; n_mc::Int64) at 10-2-numerical-method.qmd:444, 1), (mc_bad at 10-2-numerical-method.qmd:439 [inlined], 1), (loss(α::Float64, σ::Float64; fn_mc::typeof(mc_bad), d::Vector{Float64}) at 10-2-numerical-method.qmd:451, 1), ((::var"#16#17")(x::Vector{Float64}, p::SciMLBase.NullParameters) at 10-2-numerical-method.qmd:453, 1), ((::OptimizationFunction{true, SciMLBase.NoAD, var"#16#17", Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, typeof(SciMLBase.DEFAULT_OBSERVED_NO_TIME), Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing, Nothing})(::Vector{Float64}, ::Vararg{Any}) at scimlfunctions.jl:4276, 1)  …  (with_inline_display(f::QuartoNotebookWorker.var"#7#8"{String, String, Int64, Dict{Any, Any}}, cell_options::Dict{Any, Any}) at InlineDisplay.jl:31, 1), (_render_thunk(thunk::Function, code::String, cell_options::Dict{Any, Any}, is_expansion_ref::Base.RefValue{Bool}; inline::Bool) at render.jl:43, 1), (_render_thunk at render.jl:35 [inlined], 1), (render(code::String, file::String, line::Int64, cell_options::Dict{Any, Any}; inline::Bool) at render.jl:15, 1), (render(code::String, file::String, line::Int64, cell_options::Dict{Any, Any}) at render.jl:1, 1), (render(::String, ::Vararg{Any}; kwargs::Base.Pairs{Symbol, Union{}, Nothing, @NamedTuple{}}) at startup.jl:145, 1), (top-level scope at none:1, 1), (eval(m::Module, e::Any) at boot.jl:489, 1), ((::Main.var"#22#23")(chan::Channel{Any}) at startup.jl:158, 1), ((::Base.var"#562#563"{Main.var"#22#23", Channel{Any}})() at channels.jl:141, 1)])</code></pre>
</div>
</div>
<p>ナイーブな実装として, パラメータ <span class="math inline">\(\alpha, \sigma\)</span> を変化させるたびに新たに乱数を生成する方法を示しました. これでは, 最適化アルゴリズムが正しく動作しません. 例えば, 上記のコードを実行すると, 収束すべき <code>hours_worked</code> の時点で失敗してしまいました. これは, SMMの中の推定が安定せず, <code>α, σ</code> がかなり極端な値に飛んでしまったためです.</p>
<section id="良い実装例" class="level3">
<h3 class="anchored" data-anchor-id="良い実装例">良い実装例</h3>
<p>SMMで推定するパラメータが確率分布のパラメータであるときは, どのように乱数を生成すれば良いでしょうか. これには大きく二つの方法があります.</p>
<p><strong>1. 逆関数法</strong> (Inverse Transform Sampling)</p>
<p>累積分布関数 (CDF) の逆関数 (分位点関数) を用いる方法です. 任意の確率分布 <span class="math inline">\(F(x; \theta)\)</span> に対して, 一様乱数 <span class="math inline">\(u \sim U[0, 1]\)</span> を生成し, <span class="math inline">\(x = F^{-1}(u; \theta)\)</span> とすることで, パラメータ <span class="math inline">\(\theta\)</span> に依存した乱数を生成できます. SMMでは, <span class="math inline">\(u\)</span> を固定し, <span class="math inline">\(\theta\)</span> を変化させることで, 滑らかな目的関数を得ることができます.</p>
<div id="cell-smm-mc-inverse" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>us_fixed <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">10</span><span class="op">^</span><span class="fl">3</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mc_inverse</span>(α, σ; us<span class="op">=</span>us_fixed)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    hs <span class="op">=</span> <span class="fu">similar</span>(us)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    learns <span class="op">=</span> <span class="fu">similar</span>(hs)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">=</span> <span class="fu">quantile</span>.(<span class="fu">LogNormal</span>(<span class="fl">0</span>, σ), us)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, w) <span class="kw">in</span> <span class="fu">enumerate</span>(ws)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="fu">hours_worked</span>(w; α<span class="op">=</span>α)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        hs[i] <span class="op">=</span> h</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        learns[i] <span class="op">=</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> h))</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="fu">mean</span>(hs), <span class="fu">std</span>(learns)]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>prob <span class="op">=</span> <span class="fu">OptimizationProblem</span>((x, p) <span class="op">-&gt;</span> <span class="fu">loss</span>(x[<span class="fl">1</span>], x[<span class="fl">2</span>], fn_mc<span class="op">=</span>mc_inverse),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span>, <span class="fl">0.5</span>], lb<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">1e-3</span>], ub<span class="op">=</span>[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>sol <span class="op">=</span> <span class="fu">solve</span>(prob, NLopt.<span class="fu">LN_SBPLX</span>())</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>α, σ <span class="op">=</span> sol.x</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="smm-mc-inverse" class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2-element Vector{Float64}:
 3.7240732754118326
 0.899322477232912</code></pre>
</div>
</div>
<p><strong>2. 位置・尺度変換</strong> (Location-scale Transformation)</p>
<p>正規分布や一様分布のように, 標準分布 <span class="math inline">\(Z\)</span> からの線形変換 <span class="math inline">\(X = \mu + \sigma Z\)</span> で表現できる分布 (位置・尺度母数族) の場合, 標準分布からの乱数を固定して変換する方法が使えます. 対数正規分布の場合も, <span class="math inline">\(\log w \sim N(\mu, \sigma^2)\)</span> なので, <span class="math inline">\(\log w = \mu + \sigma \varepsilon,\quad\varepsilon \sim N(0, 1)\)</span> と表せます.</p>
<div id="cell-smm-transform" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>εs_fixed <span class="op">=</span> <span class="fu">randn</span>(<span class="fl">10</span><span class="op">^</span><span class="fl">3</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mc_transform</span>(α, σ; εs<span class="op">=</span>εs_fixed)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    hs <span class="op">=</span> <span class="fu">similar</span>(εs)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    learns <span class="op">=</span> <span class="fu">similar</span>(hs)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">=</span> <span class="fu">exp</span>.(σ <span class="op">.*</span> εs)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, w) <span class="kw">in</span> <span class="fu">enumerate</span>(ws)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="fu">hours_worked</span>(w; α<span class="op">=</span>α)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        hs[i] <span class="op">=</span> h</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        learns[i] <span class="op">=</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> h))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="fu">mean</span>(hs), <span class="fu">std</span>(learns)]</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>prob <span class="op">=</span> <span class="fu">OptimizationProblem</span>((x, p) <span class="op">-&gt;</span> <span class="fu">loss</span>(x[<span class="fl">1</span>], x[<span class="fl">2</span>], fn_mc<span class="op">=</span>mc_transform),</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span>, <span class="fl">0.5</span>], lb<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">1e-3</span>], ub<span class="op">=</span>[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>sol <span class="op">=</span> <span class="fu">solve</span>(prob, NLopt.<span class="fu">LN_SBPLX</span>())</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>α, σ <span class="op">=</span> sol.x</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="smm-transform" class="cell-output cell-output-display" data-execution_count="1">
<pre><code>2-element Vector{Float64}:
 3.6752461544094808
 0.8845469509294177</code></pre>
</div>
</div>
<p>なお, 多変数正規分布 <span class="math inline">\(X \sim \mathcal{N}\left(\symbf{\mu}, \Sigma \right)\)</span> は, <span class="math inline">\(X = \symbf{\mu} + L \Xi,\quad \Xi \sim \mathcal{N}(\symbf{0}, I)\)</span> と表せます. ここで, <span class="math inline">\(L\)</span> は <span class="math inline">\(\Sigma\)</span> のCholesky分解です. したがって, 多変量正規分布の場合も, 標準正規分布からの乱数を固定して変換する方法が使えます.</p>


<!-- -->


</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-perla" class="csl-entry" role="listitem">
Perla, Jesse, Thomas J. Sargent, and John Stachurski. n.d. <span>“Quantitative <span>Economics</span> with <span>Julia</span>.”</span> <em>Quantitative Economics with Julia</em>. https://julia.quantecon.org/intro.html. Accessed October 8, 2025.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><code>@time</code> マクロでも簡易的に測定できますが, 関数の宣言によるコンパイル時間なども含んでしまうため, 関数の実行速度を正確に測定するには <code>BenchmarkTools.jl</code> パッケージを使うのが望ましいです.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/kazuyanagimoto\.github\.io\/course-kobe-macro4-2025\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> 数値計算の補足</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-10-11</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> julia</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="an">julia:</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">  exeflags: ["--threads=auto"]</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>このページは数値計算に関する補足を雑多にまとめたものです. 書きかけの内容を多く含みます.</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Plots</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LaTeXStrings</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Roots</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Optimization</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">OptimizationNLopt</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Random</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(<span class="fl">1234</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="fu">default</span>(size<span class="op">=</span>(<span class="fl">500</span>, <span class="fl">309</span>), titlefontsize<span class="op">=</span><span class="fl">10</span>, fmt<span class="op">=:</span>svg)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## 計算量</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>アルゴリズムの効率性を評価する尺度として、計算時間とメモリ使用量があります. ここでいう計算時間とは, アルゴリズムが終了するまでにかかるステップ数 (**時間計算量**, time complexity) のことをいい, 実際のPC上での実行時間とは異なります. より高いスペックのPCを使えば, 同じアルゴリズムでも実行時間は短くなる一方で, ステップ数の次元が異なるアルゴリズムはマシンの性能に関わらず効率的と言えます.また, メモリ使用量とはアルゴリズムが終了するまでに必要なメモリの量 (**領域計算量**, space complexity) のことをいいます.</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="fu">### 時間計算量</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>時間計算量は, 入力の大きさ $n$ に対するステップ数 $T(n)$ の関数として表されます. 例えば, 配列の要素数が $n$ のときに, すべての要素を1回ずつ見るアルゴリズムは, $T(n) = n$ となります. また, 2重ループで配列のすべての組み合わせを調べるアルゴリズムは, $T(n) = n^2$ となります. このように, アルゴリズムの時間計算量は, 入力の大きさに対するステップ数の増加率によって特徴づけられます.</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>時間計算量を評価する際, 重要なのは支配的な項の次元数になります. 例えば, $T(n) = 3n^2 + 2n + 1$ の場合, $n$ が大きくなると $3n^2$ の項が支配的になるため, $n^2$ に着目すれば十分です. この考え方に従ったとき, 計算量を $O(n^2)$ と表記します. より厳密に表現すると以下のようになります.</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## $O$-記法</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>$f(n)$ が $O(g(n))$ とは, 任意の $n \ge 0$ に対して, ある定数 $C &gt; 0$ が存在して, 以下の不等式が成り立つことをいう.</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span>f(n)<span class="pp">|</span> \le C <span class="pp">|</span>g(n)<span class="pp">|</span>.</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>定量モデルで気にする必要があるのは, ほとんどの場合, グリッド数によるオーダーです. 例えば, $V(k, z)$ のような2次元の価値関数をグリッド上で計算する場合, $k$ のグリッド数 $n_k$ と $z$ のグリッド数 $n_z$ に対して, 計算量は $n_k n_z$ の関数となります.</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a><span class="fu">### 領域計算量</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>領域計算量は, アルゴリズムが終了するまでに必要なメモリの量を, 入力の大きさ $n$ に対する関数として表します. 例えば, 配列の要素数が $n$ のときに, すべての要素を保存するアルゴリズムは, 領域計算量が $O(n)$ となります. また, 2次元配列を保存するアルゴリズムは, 領域計算量が $O(n^2)$ となります.</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>**メモリのヒエラルキー**</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>なぜメモリの使用量が重要なのでしょうか. 近年のPCは何百GBもの容量があるし, いくら使おうと問題ではないのではないか, と思うかもしれません. しかし, 実際には, メモリのヒエラルキー (memory hierarchy) によって, メモリの速度と容量が大きく異なります.</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>一般に, 高速なメモリは高価であるため搭載量が少なく, 低速なメモリは安価であるため搭載量が多いです. それらを合わせると @fig-memory-hierarchy ようなピラミッド型のヒエラルキーが形成されます.</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a><span class="al">![Memory Hierarchy.](/static/img/lecture/memory_hierarchy.drawio.svg)</span>{#fig-memory-hierarchy fig-align="center"}</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>レジスタ (Registers): CPU内部にある最も高速なメモリ</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>キャッシュ (Cache): (近年では) CPU内部にある高速なメモリ. L1, L2, L3 などのレベルがある. ここまでCPU内部にある.</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>主記憶 (Main Memory): RAM (Random Access Memory)</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>補助記憶 (Auxiliary Storage): SSD (Solid State Drive) やHDD (Hard Disk Drive)</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>たとえば, AMDの最新世代のCPUである <span class="co">[</span><span class="ot">Ryzen 5 9600</span><span class="co">](https://www.amd.com/en/products/processors/desktops/ryzen/9000-series/amd-ryzen-5-9600.html)</span> の場合, L1キャッシュは480KB, L2キャッシュは6MB, L3キャッシュは32MBです. レジスタはサイズで表現することはあまりありませんが, ざっくり数百B程度と考えてください. 一方で, 一般にメモリと呼ばれる RAM は8GBから64GB 程度が一般的です. さらに, 一般にストレージとよばれるSSDやHDDは数百GBから数TBの容量があります.</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="fu">### 計算量の実践</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>実際にモデルを使って, 計算量を測定してみましょう. 例えば, 以下のような単純なライフサイクルモデルを考えます.</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>**Model**</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>\max_{<span class="sc">\{</span>c_t, a_{t+1}<span class="sc">\}</span>_{t=0}^{T-1}} \sum_{t=0}^{T-1} \beta^t u(c_t) <span class="sc">\\</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>\quad\text{s.t. } c_t + a_{t+1} = (1+r) a_t + w, \quad a_0 \text{ given}, \quad a_T \ge 0.</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>これは後方帰納法で解くことができます. コードで表すと次の <span class="in">`solve!`</span> 関数のようになります.</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model-life-cycle</span></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> My</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a><span class="pp">@kwdef</span> <span class="kw">struct</span> Model{TF<span class="op">&lt;:</span><span class="dt">AbstractFloat</span>,TI<span class="op">&lt;:</span><span class="dt">Integer</span>}</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Utility function</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>    γ<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">2.0</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>    β<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">0.96</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>    T<span class="op">::</span><span class="dt">Int </span><span class="op">=</span> <span class="fl">10</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prices</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>    r<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">0.07</span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>    w<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">5.0</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid for assets</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>    n_a<span class="op">::</span><span class="dt">TI </span><span class="op">=</span> <span class="fl">30</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    a_min<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    a_max<span class="op">::</span><span class="dt">TF </span><span class="op">=</span> <span class="fl">4.0</span></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    a_grid<span class="op">::</span><span class="dt">Vector{TF} </span><span class="op">=</span> <span class="fu">collect</span>(<span class="fu">range</span>(start<span class="op">=</span>a_min, stop<span class="op">=</span>a_max, length<span class="op">=</span>n_a))</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Value function</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    V<span class="op">::</span><span class="dt">Matrix{TF} </span><span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a><span class="fu">u</span>(c, m<span class="op">::</span><span class="dt">Model</span>) <span class="op">=</span> <span class="fu">isone</span>(m.γ) ? <span class="fu">log</span>(c) <span class="op">:</span> c<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> m.γ) <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> m.γ)</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve!</span>(m<span class="op">::</span><span class="dt">Model</span>)</span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>    (; T, n_a, r, w, β, a_grid) <span class="op">=</span> m</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="op">=</span> T<span class="op">:-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span>, i_a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>        utility <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i_a′ <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>            V′ <span class="op">=</span> (t <span class="op">==</span> T) ? <span class="fl">0.0</span> <span class="op">:</span> V[i_a′, t<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>            c <span class="op">=</span> (<span class="fl">1</span> <span class="op">+</span> r) <span class="op">*</span> a_grid[i_a] <span class="op">+</span> w <span class="op">-</span> a_grid[i_a′]</span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> c <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>                utility <span class="op">=</span> <span class="fu">max</span>(<span class="fu">u</span>(c, m) <span class="op">+</span> β <span class="op">*</span> V′, utility)</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>        V[i_a, t] <span class="op">=</span> utility</span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>    m.V <span class="op">.=</span> V</span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> <span class="co"># module My</span></span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>時間計算量の数え方として, 四則演算, 比較 (<span class="in">`&gt;`</span>, <span class="in">`max`</span> など), 代入, 配列へのアクセスは $O(1)$ とします. すると, 計算回数の主要部は for-loop つまり, $O(n_a^2 T)$ です. メモリ使用量は, 価値関数 $V$ の保存に使用している部分が支配的なので $O(n_a T)$ です. では, $T = 10$ で固定して, $n_a$ を変化させたときの計算時間とメモリ使用量を測定してみましょう.</span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>**BenchmarkTools.jl**</span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>Juliaでは, <span class="in">`BenchmarkTools.jl`</span> パッケージを使うと実際の計算時間とメモリ使用量を測定できます.^<span class="co">[</span><span class="ot">`@time` マクロでも簡易的に測定できますが, 関数の宣言によるコンパイル時間なども含んでしまうため, 関数の実行速度を正確に測定するには `BenchmarkTools.jl` パッケージを使うのが望ましいです.</span><span class="co">]</span></span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">BenchmarkTools</span></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> My.<span class="fu">solve!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">100</span>))</span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a><span class="in">`@benchmark`</span> マクロは上記のように関数の実行時間に合わせて適切な試行回数を自動で決定し, 実行時間の分布を表示してくれます. 基本的には中央値 (median) を見るのが良いでしょう. </span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>メモリ使用量も8.08KiBと表示されています. 今回の配列 <span class="in">`V`</span> は <span class="in">`Float64`</span> 型の2次元配列で, $n_a$ 行 $T$ 列なので, メモリ使用量は $8 n_a T$ バイトになります (64bit = 8バイト) . 例えば, $n_a = 100$ のときは $8 \times 100 \times 10 = 8000$ バイトで, 8.08KiB (1KiB = 1024バイト) とほぼ一致しています.</span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>次に $n_a = 1000$ としたときの計算時間を測定してみましょう.</span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> My.<span class="fu">solve!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">1000</span>))</span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>おおむね計算時間が100倍, メモリ使用量が10倍になっていることがわかります. これは, 計算時間が $O(n_a^2 T)$, メモリ使用量が $O(n_a T)$ であることと一致しています.</span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a><span class="fu">## 微分</span></span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>数値計算の文脈において微分は主に3種類あります.</span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>数式微分 (Symbolic Differentiation)</span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>数値微分 (Numerical Differentiation)</span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>自動微分 (Automatic Differentiation)</span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a>数式微分 (手計算による解析的な微分) が可能な場合は, これが最も高速で効率的ですが, 複雑な関数に対しては, 数値微分や自動微分などで計算する必要があります. 以下では, 次のラグランジアンを例に, それぞれの微分方法を説明します.</span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a>\mathcal{L} = \phi \log \left(w(1-l)\right)  + (1-\phi) \frac{l^{1-\gamma}}{1-\gamma}</span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a><span class="fu">### 数式微分 (Symbolic Differentiation)</span></span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>いわゆる手計算による微分です. 一階条件を求めると,</span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a>\frac{\partial \mathcal{L}}{\partial l} = -\frac{\phi}{1-l} + (1-\phi) l^{-\gamma} = 0.</span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a><span class="in">`Symbolics.jl`</span> パッケージを使うと, Julia上で数式微分を行うこともできます.</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: symbolic-diff</span></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: asis</span></span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Symbolics</span></span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Latexify</span></span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a><span class="pp">@variables</span> w l ϕ γ</span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a>L <span class="op">=</span> ϕ <span class="op">*</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> l)) <span class="op">+</span> (<span class="fl">1</span> <span class="op">-</span> ϕ) <span class="op">*</span> l<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> γ) <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> γ)</span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a>∂l <span class="op">=</span> <span class="fu">Differential</span>(l)</span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a>∂L∂l <span class="op">=</span> <span class="fu">expand_derivatives</span>(<span class="fu">∂l</span>(L))</span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="fu">latexify</span>(∂L∂l))</span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### 数値微分 (Numerical Differentiation)</span></span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a>f'(x) = \lim_{\Delta \to 0} \frac{f(x+\Delta) - f(x)}{\Delta}.</span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a>数値微分は上記の微分の定義を数値的に近似する方法です. 定義通りに行うと, 非常に小さい $d$ (例えば $10^{-9}$ など) を使って, 以下のように近似できます.</span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a>f'(x) \approx \frac{f(x+d) - f(x)}{d}.</span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a>実用上は, 中心差分 (central difference) を使うことが多いです.</span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a>f'(x) \approx \frac{f(x+\frac{1}{2}d) - f(x-\frac{1}{2}d)}{d}.</span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a>Julia では, <span class="in">`FiniteDiff.jl`</span> パッケージを使うと数値微分ができます.</span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: numerical-diff</span></span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">FiniteDiff</span></span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>(l; w<span class="op">=</span><span class="fl">1</span>., ϕ<span class="op">=</span><span class="fl">0.5</span>, γ<span class="op">=</span><span class="fl">1.5</span>) <span class="op">=</span> ϕ <span class="op">*</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> l)) <span class="op">+</span> (<span class="fl">1</span> <span class="op">-</span> ϕ) <span class="op">*</span> l<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> γ) <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> γ)</span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_analytical</span>(l; w<span class="op">=</span><span class="fl">1</span>., ϕ<span class="op">=</span><span class="fl">0.5</span>, γ<span class="op">=</span><span class="fl">1.5</span>) <span class="op">=</span> <span class="op">-</span>ϕ <span class="op">/</span> (<span class="fl">1</span> <span class="op">-</span> l) <span class="op">+</span> (<span class="fl">1</span> <span class="op">-</span> ϕ) <span class="op">*</span> l<span class="op">^</span>(<span class="op">-</span>γ)</span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_numerical</span>(l; Δ<span class="op">=</span><span class="fl">1e-9</span>) <span class="op">=</span> (<span class="fu">f</span>(l <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> Δ) <span class="op">-</span> <span class="fu">f</span>(l <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> Δ)) <span class="op">/</span> Δ</span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_finitediff</span>(l) <span class="op">=</span> FiniteDiff.<span class="fu">finite_difference_derivative</span>(l <span class="op">-&gt;</span> <span class="fu">f</span>(l), l)</span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-comp-numerical-diff</span></span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison of analytical and numerical derivatives."</span></span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_analytical, label<span class="op">=</span><span class="st">"Analytical"</span>)</span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_numerical, label<span class="op">=</span><span class="st">"Numerical"</span>, linestyle<span class="op">=:</span>dash)</span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_finitediff, label<span class="op">=</span><span class="st">"FiniteDiff.jl"</span>, linestyle<span class="op">=:</span>dot)</span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a><span class="fu">### 自動微分 (Automatic Differentiation)</span></span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a>数値微分はとてもシンプルな実装ですが, $d$ の選び方によっては精度が悪くなる可能性があります. より高い精度を求める場合は, 自動微分を用いることができます. 自動微分は, 関数を基本的な演算 (多項式, 三角関数, 対数関数など) の組み合わせとして分解し, 各基本演算の微分を連鎖律に基づいて計算する方法です. これは, 数式微分を数値的に実行するようなイメージです.</span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>**順伝播と逆伝播**</span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a>\frac{dy}{dx} = \frac{dy}{du} \cdot \frac{du}{dx}</span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>順伝播 (forward mode): 入力から出力に向かって微分を計算する方法.</span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\frac{du}{dx}$ を計算し, それを用いて $\frac{dy}{du}$ を計算する.</span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>逆伝播 (reverse mode): 出力から入力に向かって微分を計算する方法.</span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>$\frac{dy}{du}$ を計算し, それを用いて $\frac{du}{dx}$ を計算する.</span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a>一般に $f: \mathbb{R}^m \to \mathbb{R}^n$ に対して, $m &gt; n$ の場合は逆伝播が効率的であり, $m &lt; n$ の場合は順伝播が効率的です. 例えば, ニューラルネットワークでは, 多数のパラメータ (重み) を持つモデルに対して, 単一の損失関数を最小化するために逆伝播がよく使われます.</span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a>順伝播の効率的な実装は双対数 (dual numbers) を用いて行えることが知られています. 一方, 逆伝播の効率的な実装は難しく, 様々な手法が提案されている状況です. 詳しくは, @perla の<span class="co">[</span><span class="ot">9.2節</span><span class="co">](https://julia.quantecon.org/more_julia/optimization_solver_packages.html)</span> を参照してください.</span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a>Julia では, <span class="in">`ForwardDiff.jl`</span> パッケージを使うと順伝播の自動微分ができます.</span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: automatic-diff</span></span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ForwardDiff</span></span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a><span class="fu">f′_forwarddiff</span>(l) <span class="op">=</span> ForwardDiff.<span class="fu">derivative</span>(l <span class="op">-&gt;</span> <span class="fu">f</span>(l), l)</span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-comp-automatic-diff</span></span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison of analytical and automatic derivatives."</span></span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_analytical, label<span class="op">=</span><span class="st">"Analytical"</span>)</span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(<span class="fl">0.2</span><span class="op">:</span><span class="fl">0.01</span><span class="op">:</span><span class="fl">0.9</span>, f′_forwarddiff, label<span class="op">=</span><span class="st">"ForwardDiff.jl"</span>, linestyle<span class="op">=:</span>dash)</span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a><span class="fu">## 並列計算</span></span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a>現代のPCは複数のコアを持つマルチコアCPUを搭載しています. パッケージのバックグラウンドで並列計算が用いられていることもありますが, 基本的にはユーザーが明示的に並列計算を指示する必要があります.</span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a>まずは, 自分のPCが何コア持っているかを確認してみましょう.</span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-cores</span></span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a><span class="bu">Threads</span>.<span class="fu">nthreads</span>()</span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a>ここで, スレッド数が1となっている場合は, Juliaを起動する前に環境変数 <span class="in">`JULIA_NUM_THREADS`</span> を設定する必要があります. </span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Quarto: <span class="in">`julia.exeflags: ["--threads=auto"]`</span> をYAMLヘッダーに追加</span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>VSCode: <span class="in">`settings.json`</span> に <span class="in">`"julia.numThreads": "auto"`</span> を追加</span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>ターミナル: <span class="in">`export JULIA_NUM_THREADS=auto`</span> を実行</span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a><span class="in">`auto`</span> と設定した場合, 利用可能なコア数に応じて自動的にスレッド数が設定されます. 現代のPCであれば, ほとんどの場合, 利用可能なコア数が2以上になるはずです.</span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: define-solve-multi</span></span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_multi!</span>(m<span class="op">::</span><span class="dt">My.Model</span>)</span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a>    (; T, n_a, r, w, β, a_grid) <span class="op">=</span> m</span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="op">=</span> T<span class="op">:-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span></span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> i_a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a>            utility <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i_a′ <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a>                V′ <span class="op">=</span> (t <span class="op">==</span> T) ? <span class="fl">0.0</span> <span class="op">:</span> V[i_a′, t<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a>                c <span class="op">=</span> (<span class="fl">1</span> <span class="op">+</span> r) <span class="op">*</span> a_grid[i_a] <span class="op">+</span> w <span class="op">-</span> a_grid[i_a′]</span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> c <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a>                    utility <span class="op">=</span> <span class="fu">max</span>(My.<span class="fu">u</span>(c, m) <span class="op">+</span> β <span class="op">*</span> V′, utility)</span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a>            V[i_a, t] <span class="op">=</span> utility</span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a>    m.V <span class="op">.=</span> V</span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: benchmark-single</span></span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> My.<span class="fu">solve!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">1000</span>))</span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: benchmark-multi</span></span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a><span class="pp">@benchmark</span> <span class="fu">solve_multi!</span>(m) setup <span class="op">=</span> (m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">1000</span>))</span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a>並列化した場合, 1コアで実行した場合と比べて, おおむねスレッド数に応じて計算時間が短縮されていることがわかります. ただし, ここまで理論値に近い速度向上が得られることは稀で, 実際には理論値の数%から数十%程度の速度向上にとどまることが多いです.</span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a>**並列化できない計算**</span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a>並列計算の大前提は, 各スレッドが独立して計算できることです. 今回は後方帰納法で解くため, 時刻 $t$ の価値関数を計算する際に, 時刻 $t+1$ の価値関数が必要になり, 時刻方向に並列化することはできません.</span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: define-solve-muli-illegal</span></span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">solve_multi_illegal!</span>(m<span class="op">::</span><span class="dt">My.Model</span>)</span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a>    (; T, n_a, r, w, β, a_grid) <span class="op">=</span> m</span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> <span class="fu">zeros</span>(n_a, T)</span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Threads</span>.<span class="pp">@threads</span> <span class="cf">for</span> t <span class="op">=</span> T<span class="op">:-</span><span class="fl">1</span><span class="op">:</span><span class="fl">1</span></span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i_a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>            utility <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span></span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i_a′ <span class="op">=</span> <span class="fl">1</span><span class="op">:</span>n_a</span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a>                V′ <span class="op">=</span> (t <span class="op">==</span> T) ? <span class="fl">0.0</span> <span class="op">:</span> V[i_a′, t<span class="op">+</span><span class="fl">1</span>]</span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a>                c <span class="op">=</span> (<span class="fl">1</span> <span class="op">+</span> r) <span class="op">*</span> a_grid[i_a] <span class="op">+</span> w <span class="op">-</span> a_grid[i_a′]</span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> c <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a>                    utility <span class="op">=</span> <span class="fu">max</span>(My.<span class="fu">u</span>(c, m) <span class="op">+</span> β <span class="op">*</span> V′, utility)</span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a>            V[i_a, t] <span class="op">=</span> utility</span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a>    m.V <span class="op">.=</span> V</span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-vf-illegal</span></span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Value function computed with illegal parallelization."</span></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> My.<span class="fu">Model</span>(n_a<span class="op">=</span><span class="fl">100</span>)</span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a><span class="fu">solve_multi_illegal!</span>(m)</span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m.a_grid, m.V[<span class="op">:</span>, <span class="kw">end</span>], xlabel<span class="op">=</span>L<span class="st">"a"</span>, ylabel<span class="op">=</span>L<span class="st">"V(a, t)"</span>, label<span class="op">=</span>L<span class="st">"t=T"</span>)</span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(m.a_grid, m.V[<span class="op">:</span>, <span class="kw">end</span><span class="op">-</span><span class="fl">2</span>], label<span class="op">=</span>L<span class="st">"t=T-2"</span>)</span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a><span class="fu">plot!</span>(m.a_grid, m.V[<span class="op">:</span>, begin], label<span class="op">=</span>L<span class="st">"t=1"</span>)</span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a>@fig-vf-illegal のように, 時間方向に並列化すると正しい価値関数が得られません.</span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a><span class="fu">## Monte Carlo Simulation for SMM</span></span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a>SMM (Simulated Method of Moments) のようなシミュレーションベースの推定では, モデルのパラメータを変化させながら (モンテカルロ) シミュレーションを繰り返す必要があります. このとき, 正確に実装しないと, モデルのパラメータを変化させるたびにランダムな数を生成してまい, 正確な最適化ができません. そのため, モデルのパラメータを変化させるたびに新たに乱数を生成するのではなく, 事前に乱数を生成しておきそれを使いまわす必要があります.</span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a>例として, 第二回の授業で扱った次のモデルを考えましょう.</span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a>**モデル**</span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a>\max_{c, l} u(c, l) = \frac{c^{1-\gamma_c}}{1-\gamma_c} + \alpha_l \frac{l^{1-\gamma_l}}{1-\gamma_l} \quad \text{s.t.} \quad c = w (1 - l),</span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a>where</span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>\log w \sim \mathcal{N}(\mu, \sigma).</span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a>標準化のため, $\mu = 0$ とする. この時, $\theta = (\alpha, \sigma)$ を推定する.</span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prep-dist-earn</span></span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a>mean_hours_data <span class="op">=</span> <span class="fl">33.4</span> <span class="op">/</span> (<span class="fl">16</span> <span class="op">*</span> <span class="fl">7</span>)</span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a>earn <span class="op">=</span> [<span class="fl">25</span>, <span class="fl">75</span>, <span class="fl">150</span>, <span class="fl">250</span>, <span class="fl">350</span>, <span class="fl">450</span>, <span class="fl">550</span>, <span class="fl">650</span>, <span class="fl">750</span>, <span class="fl">850</span>, <span class="fl">950</span>, <span class="fl">1100</span>, <span class="fl">1200</span>]</span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a>density <span class="op">=</span> [<span class="fl">13.7</span>, <span class="fl">12.2</span>, <span class="fl">12.3</span>, <span class="fl">14.8</span>, <span class="fl">20.2</span>, <span class="fl">16.3</span>, <span class="fl">7.0</span>, <span class="fl">2.0</span>, <span class="fl">0.6</span>, <span class="fl">0.4</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>] <span class="op">/</span> <span class="fl">100</span></span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a>mean_learn_data <span class="op">=</span> density<span class="op">'</span> <span class="op">*</span> <span class="fu">log</span>.(earn)</span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a>sd_learn_data <span class="op">=</span> <span class="fu">sqrt</span>(density<span class="op">'</span> <span class="op">*</span> (<span class="fu">log</span>.(earn) <span class="op">.-</span> mean_learn_data) <span class="op">.^</span> <span class="fl">2</span>)</span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a><span class="fu">foc</span>(l; w<span class="op">=</span><span class="fl">1.0</span>, γ_c<span class="op">=</span><span class="fl">1.5</span>, α_l<span class="op">=</span><span class="fl">1.2</span>, γ_l<span class="op">=</span><span class="fl">1.5</span>) <span class="op">=</span></span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a>    w<span class="op">^</span>(<span class="fl">1</span> <span class="op">-</span> γ_c) <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> l)<span class="op">^</span>(<span class="op">-</span>γ_c) <span class="op">-</span> α_l <span class="op">*</span> l<span class="op">^</span>(<span class="op">-</span>γ_l)</span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">hours_worked</span>(w; γ_c<span class="op">=</span><span class="fl">1.5</span>, γ_l<span class="op">=</span><span class="fl">1.5</span>, α<span class="op">=</span><span class="fl">1.2</span>)</span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a>    y<span class="op">::</span><span class="dt">Float64 </span><span class="op">=</span> <span class="fu">find_zero</span>(y <span class="op">-&gt;</span> <span class="fu">foc</span>(<span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu">exp</span>(y)), w<span class="op">=</span>w, γ_c<span class="op">=</span>γ_c, α_l<span class="op">=</span>α, γ_l<span class="op">=</span>γ_l), <span class="fl">0.0</span>)</span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a>    l <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu">exp</span>(y))</span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1</span> <span class="op">-</span> l</span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a>**悪い実装例**</span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: smm-mc-naive</span></span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mc_bad</span>(α, σ; n_mc<span class="op">=</span><span class="fl">10</span><span class="op">^</span><span class="fl">3</span>)</span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">=</span> <span class="fu">rand</span>(<span class="fu">LogNormal</span>(<span class="fl">0</span>, σ), n_mc)</span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a>    hs <span class="op">=</span> <span class="fu">similar</span>(ws)</span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a>    learns <span class="op">=</span> <span class="fu">similar</span>(hs)</span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, w) <span class="kw">in</span> <span class="fu">enumerate</span>(ws)</span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="fu">hours_worked</span>(w; α<span class="op">=</span>α)</span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a>        hs[i] <span class="op">=</span> h</span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a>        learns[i] <span class="op">=</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> h))</span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="fu">mean</span>(hs), <span class="fu">std</span>(hs)]</span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a><span class="fu">loss</span>(α, σ; fn_mc, d<span class="op">=</span>[mean_hours_data, sd_learn_data]) <span class="op">=</span></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">sum</span>(((<span class="fu">fn_mc</span>(α, σ) <span class="op">.-</span> d) <span class="op">./</span> d) <span class="op">.^</span> <span class="fl">2</span>))</span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a>prob <span class="op">=</span> <span class="fu">OptimizationProblem</span>((x, p) <span class="op">-&gt;</span> <span class="fu">loss</span>(x[<span class="fl">1</span>], x[<span class="fl">2</span>], fn_mc<span class="op">=</span>mc_bad), [<span class="fl">0.5</span>, <span class="fl">0.5</span>],</span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a>    lb<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">1e-3</span>], ub<span class="op">=</span>[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span></span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a>    sol <span class="op">=</span> <span class="fu">solve</span>(prob, NLopt.<span class="fu">LN_SBPLX</span>())</span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a><span class="cf">catch</span> <span class="cn">e</span></span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Optimization failed as expected:"</span>)</span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="cn">e</span>)</span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>ナイーブな実装として, パラメータ $\alpha, \sigma$ を変化させるたびに新たに乱数を生成する方法を示しました. これでは, 最適化アルゴリズムが正しく動作しません. 例えば, 上記のコードを実行すると, 収束すべき <span class="in">`hours_worked`</span> の時点で失敗してしまいました. これは, SMMの中の推定が安定せず, <span class="in">`α, σ`</span> がかなり極端な値に飛んでしまったためです.</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a><span class="fu">### 良い実装例</span></span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a>SMMで推定するパラメータが確率分布のパラメータであるときは, どのように乱数を生成すれば良いでしょうか. これには大きく二つの方法があります.</span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a>**1. 逆関数法** (Inverse Transform Sampling)</span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a>累積分布関数 (CDF) の逆関数 (分位点関数) を用いる方法です. 任意の確率分布 $F(x; \theta)$ に対して, 一様乱数 $u \sim U<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$ を生成し, $x = F^{-1}(u; \theta)$ とすることで, パラメータ $\theta$ に依存した乱数を生成できます. SMMでは, $u$ を固定し, $\theta$ を変化させることで, 滑らかな目的関数を得ることができます.</span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: smm-mc-inverse</span></span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a>us_fixed <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">10</span><span class="op">^</span><span class="fl">3</span>)</span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mc_inverse</span>(α, σ; us<span class="op">=</span>us_fixed)</span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a>    hs <span class="op">=</span> <span class="fu">similar</span>(us)</span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>    learns <span class="op">=</span> <span class="fu">similar</span>(hs)</span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">=</span> <span class="fu">quantile</span>.(<span class="fu">LogNormal</span>(<span class="fl">0</span>, σ), us)</span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, w) <span class="kw">in</span> <span class="fu">enumerate</span>(ws)</span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="fu">hours_worked</span>(w; α<span class="op">=</span>α)</span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a>        hs[i] <span class="op">=</span> h</span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a>        learns[i] <span class="op">=</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> h))</span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="fu">mean</span>(hs), <span class="fu">std</span>(learns)]</span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a>prob <span class="op">=</span> <span class="fu">OptimizationProblem</span>((x, p) <span class="op">-&gt;</span> <span class="fu">loss</span>(x[<span class="fl">1</span>], x[<span class="fl">2</span>], fn_mc<span class="op">=</span>mc_inverse),</span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span>, <span class="fl">0.5</span>], lb<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">1e-3</span>], ub<span class="op">=</span>[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a>sol <span class="op">=</span> <span class="fu">solve</span>(prob, NLopt.<span class="fu">LN_SBPLX</span>())</span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a>α, σ <span class="op">=</span> sol.x</span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a>**2. 位置・尺度変換** (Location-scale Transformation)</span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a>正規分布や一様分布のように, 標準分布 $Z$ からの線形変換 $X = \mu + \sigma Z$ で表現できる分布 (位置・尺度母数族) の場合, 標準分布からの乱数を固定して変換する方法が使えます. 対数正規分布の場合も, $\log w \sim N(\mu, \sigma^2)$ なので, $\log w = \mu + \sigma \varepsilon,\quad\varepsilon \sim N(0, 1)$ と表せます.</span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: smm-transform</span></span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a>εs_fixed <span class="op">=</span> <span class="fu">randn</span>(<span class="fl">10</span><span class="op">^</span><span class="fl">3</span>)</span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mc_transform</span>(α, σ; εs<span class="op">=</span>εs_fixed)</span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a>    hs <span class="op">=</span> <span class="fu">similar</span>(εs)</span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a>    learns <span class="op">=</span> <span class="fu">similar</span>(hs)</span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">=</span> <span class="fu">exp</span>.(σ <span class="op">.*</span> εs)</span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, w) <span class="kw">in</span> <span class="fu">enumerate</span>(ws)</span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> <span class="fu">hours_worked</span>(w; α<span class="op">=</span>α)</span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a>        hs[i] <span class="op">=</span> h</span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a>        learns[i] <span class="op">=</span> <span class="fu">log</span>(w <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> h))</span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="fu">mean</span>(hs), <span class="fu">std</span>(learns)]</span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a>prob <span class="op">=</span> <span class="fu">OptimizationProblem</span>((x, p) <span class="op">-&gt;</span> <span class="fu">loss</span>(x[<span class="fl">1</span>], x[<span class="fl">2</span>], fn_mc<span class="op">=</span>mc_transform),</span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.5</span>, <span class="fl">0.5</span>], lb<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">1e-3</span>], ub<span class="op">=</span>[<span class="fl">10.0</span>, <span class="fl">10.0</span>])</span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a>sol <span class="op">=</span> <span class="fu">solve</span>(prob, NLopt.<span class="fu">LN_SBPLX</span>())</span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a>α, σ <span class="op">=</span> sol.x</span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>なお, 多変数正規分布 $X \sim \mathcal{N}\left(\symbf{\mu}, \Sigma \right)$ は, $X = \symbf{\mu} + L \Xi,\quad \Xi \sim \mathcal{N}(\symbf{0}, I)$ と表せます. ここで, $L$ は $\Sigma$ のCholesky分解です. したがって, 多変量正規分布の場合も, 標準正規分布からの乱数を固定して変換する方法が使えます.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>